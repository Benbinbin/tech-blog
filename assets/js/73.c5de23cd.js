(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{1111:function(t,s,a){t.exports=a.p+"assets/img/20200126121303548_29356.25164e83.png"},1112:function(t,s,a){t.exports=a.p+"assets/img/20200513103736982_28256.41d8f8ad.png"},1113:function(t,s,a){t.exports=a.p+"assets/img/20200513105447526_13159.2716f3da.png"},1444:function(t,s,a){"use strict";a.r(s);var n=a(18),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"ajax"}},[t._v("Ajax")]),t._v(" "),n("p",[t._v("参考："),n("a",{attrs:{href:"http://codemany.com/blog/ajax-new-approach-web-applications/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ajax：Web应用的一种新方法"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("Ajax，Asynchronous JavaScript And XML，即异步的 JavaScript 与 XML 技术，该概念是在 2005 年 "),n("a",{attrs:{href:"https://web.archive.org/web/20080702075113/http://www.adaptivepath.com/ideas/essays/archives/000385.php",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jesse James Garrett 发明的"),n("OutboundLink")],1),t._v("。")]),t._v(" "),n("p",[t._v("该技术核心概念是异步请求数据，即在客户端发出数据请求后，不需要等待请求返回，借助 Ajax引擎可以继续进行其他任务处理，待请求返回后再进行异步处理，该过程不用一次次重新加载整个页面，而只需要根据响应更新特定区域的数据。")]),t._v(" "),n("p",[t._v("Ajax 技术包括：")]),t._v(" "),n("ul",[n("li",[t._v("使用 XHTML 和 CSS 的 "),n("a",{attrs:{href:"http://adaptivepath.org/publications/essays/archives/000266.php",target:"_blank",rel:"noopener noreferrer"}},[t._v("standards-based presentation"),n("OutboundLink")],1),t._v("；")]),t._v(" "),n("li",[t._v("使用 "),n("a",{attrs:{href:"http://www.scottandrew.com/weblog/articles/dom_1",target:"_blank",rel:"noopener noreferrer"}},[t._v("Document Object Model"),n("OutboundLink")],1),t._v(" 的动态显示和交互；")]),t._v(" "),n("li",[t._v("使用 "),n("a",{attrs:{href:"http://www-106.ibm.com/developerworks/xml/library/x-xslt/?article=xr",target:"_blank",rel:"noopener noreferrer"}},[t._v("XML 和 XSLT"),n("OutboundLink")],1),t._v(" 的数据交换和操控；")]),t._v(" "),n("li",[t._v("使用 "),n("a",{attrs:{href:"http://www.xml.com/pub/a/2005/02/09/xml-http-request.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest"),n("OutboundLink")],1),t._v(" 的异步数据检索；")]),t._v(" "),n("li",[n("a",{attrs:{href:"http://www.crockford.com/javascript/javascript.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("JavaScript"),n("OutboundLink")],1),t._v(" 将所有这些绑定在一起。")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(1111),alt:"Ajax 与传统的数据请求模型对比"}})]),t._v(" "),n("p",[t._v("其中 Ajax 技术核心是发送异步数据请求，可以通过多种方式实现：")]),t._v(" "),n("ul",[n("li",[t._v("使用 JavaScript 内置的 XMLHttpRequest 构造函数（创建 XMLHttpRequest/XHR 对象）生成异步请求")]),t._v(" "),n("li",[t._v("使用 jQuery 生成异步请求")]),t._v(" "),n("li",[t._v("使用 fetch API 生成异步请求")])]),t._v(" "),n("h2",{attrs:{id:"xmlhttprequest"}},[t._v("XMLHttpRequest")]),t._v(" "),n("p",[t._v("参考：")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://zh.javascript.info/xmlhttprequest",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest | 现代 JavaScript 教程"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 XMLHttpRequest - Web API 接口参考 | MDN"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://xhr.spec.whatwg.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest Standard | WHATWG 规范"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://www.w3.org/TR/XMLHttpRequest/",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest Level 1 | W3C 规范"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://www.html5rocks.com/zh/tutorials/file/xhr2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest2 新技巧"),n("OutboundLink")],1),t._v(" | "),n("a",{attrs:{href:"https://www.html5rocks.com/en/tutorials/file/xhr2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("英文"),n("OutboundLink")],1)])]),t._v(" "),n("p",[t._v("XMLHttpRequest（缩写为 XHR 或 xhr）可以用来向 API 请求任何类型的文件（例如 "),n("code",[t._v("txt")]),t._v(" 纯文本文件、"),n("code",[t._v("HTML")]),t._v(" 文件、"),n("code",[t._v("JSON")]),t._v(" 文件、图片文件等）或数据，而不仅仅是XML，它甚至支持 HTTP 以外的协议（包括 file:// 和 FTP）。")]),t._v(" "),n("p",[t._v("⚠️ 如今有一个更为现代的方法 "),n("code",[t._v("fetch")]),t._v(" 发送异步网络请求，它的出现使得 "),n("code",[t._v("XMLHttpRequest")]),t._v(" 在某种程度上被弃用。在现代 Web 开发中，出于以下三种原因，我们还在使用 "),n("code",[t._v("XMLHttpRequest")]),t._v("：")]),t._v(" "),n("ol",[n("li",[t._v("历史原因：我们需要支持现有的使用了 "),n("code",[t._v("XMLHttpRequest")]),t._v(" 的脚本。")]),t._v(" "),n("li",[t._v("我们需要兼容旧浏览器，并且不想用 polyfill。")]),t._v(" "),n("li",[t._v("我们需要做一些 "),n("code",[t._v("fetch")]),t._v(" 目前无法做到的事情，如"),n("strong",[t._v("跟踪上传进度")]),t._v("。")])]),t._v(" "),n("p",[t._v("JavaScript 引擎提供了发出异步 HTTP 请求的方式，调用其内置的 "),n("strong",[t._v("XMLHttpRequest 构造函数")]),t._v("创建 XHR 对象，以创建 Ajax 请求。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" xhr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/my/url'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// HTTP error?")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理 error")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Error: '")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取来自 xhr.response 的响应")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onprogress")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 报告下载进度")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("Loaded ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loaded"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v(" of ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("total"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onerror")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理非 HTTP error（如网络中断）")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("XMLHttpRequest 发送网络请求步骤：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("XMLHttpRequest 有两种执行模式，同步 synchronous 和异步 asynchronous，异步模式发送请求需要 3 个步骤：")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("使用 "),n("code",[t._v("XMLHttpRequest")]),t._v(" 构造函数创建 XHR 对象")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" xhr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 构造函数没有参数")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("使用 "),n("code",[t._v("open()")]),t._v(" 方法初始化 XHR 对象")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用 .open 方法时并不会建立连接，仅仅设置当前请求的配置")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("method"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("URL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("async"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" password"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("在创建 XHR 对象之后，通常调用 "),n("code",[t._v(".open()")]),t._v(" 函数指定了请求的主要参数：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("method")]),t._v(" 指代 HTTP 方法。通常是 "),n("code",[t._v("GET")]),t._v(" 或者 "),n("code",[t._v("POST")])]),t._v(" "),n("li",[n("code",[t._v("URL")]),t._v(" 指定要执行请求的 URL 字符串，或可以 URL 对象。")]),t._v(" "),n("li",[n("code",[t._v("async")]),t._v(" 如果设置为 "),n("code",[t._v("false")]),t._v(" 请求将会以同步的方式处理（默认为 "),n("code",[t._v("true")]),t._v(" 即异步执行）")]),t._v(" "),n("li",[n("code",[t._v("user")]),t._v(" 和 "),n("code",[t._v("password")]),t._v(" 指定 HTTP 基本身份认证（可选）的登录名和密码")])]),t._v(" "),n("p",[t._v("💡 使用 "),n("code",[t._v("xhr")]),t._v(" 对象属性 "),n("code",[t._v("timeout")]),t._v(" 设置超时限制，如果在给定时间内请求没有成功执行就会被取消，并且"),n("strong",[t._v("触发 "),n("code",[t._v("timeout")]),t._v(" 事件")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timeout "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timeout 单位是 ms，此处即 10 秒")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("使用方法 "),n("code",[t._v("send()")]),t._v(" 发送请求")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 建立连接，并发送请求到服务器")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("可选参数 body 包含了请求主体 :")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("GET")]),t._v(" 没有请求体")]),t._v(" "),n("li",[n("code",[t._v("POST")]),t._v(" 这类请求方式会用 "),n("code",[t._v("body")]),t._v(" 来发送数据到服务器")])])])])]),t._v(" "),n("li",[n("p",[t._v("然后就是监听响应事件，设置对成功/错误的响应的处理程序（⚠️ 需要"),n("strong",[t._v("在发出请求前")]),t._v("完成监听响应事件的设置）。常见的三个事件：")]),t._v(" "),n("ul",[n("li",[t._v("事件 "),n("code",[t._v("load")]),t._v(" 在请求结果已经返回时触发，⚠️ 请求返回也包括像 "),n("code",[t._v("404")]),t._v(" 这样的 HTTP 错误。通过 XHR 对象属性 "),n("code",[t._v("onload")]),t._v(" 监听成功返回的事件，并设置相应的处理程序")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("error")]),t._v(" 在无法完成请求时触发，比如网络中断或者无效的 URL。通过 XHR 对象属性 "),n("code",[t._v("onerroe")]),t._v(" 监听错误响应的事件，并设置无法实现请求的处理程序")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("progress")]),t._v(" 在下载期间定时触发，报告已经下载了多少。通过 XHR 对象属性 "),n("code",[t._v("onprogress")]),t._v(" 来设置下载响应过程中执行的操作")])])]),t._v(" "),n("li",[n("p",[t._v("最后如果请求成功，并获得响应消息，就需要对返回的响应体 "),n("code",[t._v("xhr.response")]),t._v(" 作进一步分析。")])])]),t._v(" "),n("h3",{attrs:{id:"open-方法"}},[t._v("open() 方法")]),t._v(" "),n("p",[t._v("XHR 对象使用方法 "),n("code",[t._v(".open(method, URL)")]),t._v(" 设置请求配置，有多个参数但是最重要的参数是前两个参数：")]),t._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTTP 方法"),n("OutboundLink")],1),t._v("，主要是两种 "),n("code",[t._v("GET")]),t._v("检索数据或 "),n("code",[t._v("POST")]),t._v(" 发送数据")]),t._v(" "),n("li",[t._v("要发送请求的 URL")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 向图片网站 Unsplash 发出首页异步请求，使用 GET 请求并提供相关 URL")]),t._v("\nasyncRequestObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://unsplash.com'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("💡 可将 "),n("code",[t._v("false")]),t._v(" 作为第三个参数使 XHR 请求变成"),n("strong",[t._v("同步请求")]),t._v("。这将导致 JavaScript 引擎在执行 "),n("code",[t._v("send()")]),t._v(" 后暂停并等待返回该请求，称为「阻止」，然后再继续。这做法完全与异步行为的目的相违背，同步请求会阻塞页面内的其他脚本执行，如果一个同步调用执行时间过长浏览器可能会建议关闭「挂起」hanging 的网页。⚠️ 请勿如此设置你的 XHR 对象！要么将第三个参数设为 "),n("code",[t._v("true")]),t._v(" 或留空（默认值变成 "),n("code",[t._v("true")]),t._v("）。")]),t._v(" "),n("p",[t._v("⚠️ 该方法并没有实际地发送请求！它的作用只是做好准备，向 XHR 对象提供请求所需的信息。")]),t._v(" "),n("p",[t._v("⚠️ 一般只能在将加载数据的"),n("strong",[t._v("同一网域中")]),t._v("发出资源和数据请求，如要向 google.com 发出异步数据请求，浏览器需要位于 "),n("code",[t._v("google.com")]),t._v(" 上，这称为 "),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy",target:"_blank",rel:"noopener noreferrer"}},[t._v("同源策略"),n("OutboundLink")],1),t._v("。这一限制是出于安全考虑，原因是 JavaScript 对网页上的太多信息具有控制权，它可以访问所有的 Cookie、能够判断密码（因为它可以追踪用户按的是哪个键）等。解决同源策略限制的方式是使用 "),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS",target:"_blank",rel:"noopener noreferrer"}},[t._v("CORS, Cross-Origin Resource Sharing 跨域请求"),n("OutboundLink")],1),t._v(" ，这是必须在服务器上实现的技术，能让开发者规避同源策略限制并访问这些服务器上的信息。")]),t._v(" "),n("h4",{attrs:{id:"post"}},[t._v("POST")]),t._v(" "),n("p",[t._v("当我们需要发送大量数据时，如表单等，需要使用 "),n("code",[t._v("POST")]),t._v(" 方法。")]),t._v(" "),n("p",[t._v("💡 如果需要处理表单数据，可以"),n("a",{attrs:{href:"#FormData"}},[t._v("使用构造函数 "),n("code",[t._v("FormData([form])")]),t._v(" 创建一个 HTML 表单数据对象")]),t._v("，可以使用该对象提供的许多便捷方法。当以 FormData 对象作为 request body 时，即 "),n("code",[t._v("xhr.send(formData)")]),t._v("，则请求表头会含有  "),n("code",[t._v("Content-Type: multipart/form-data")]),t._v(" 的 header。")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("form")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("person"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("John"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("surname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Smith"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("form")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从表单预填充 FormData")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" formData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("forms"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("person"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 附加一个字段")]),t._v("\n  formData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"middle"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Lee"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将其发送出去")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" xhr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"POST"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/article/xmlhttprequest/post/user"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 POST 方法")]),t._v("\n  xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("formData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("h3",{attrs:{id:"http-header"}},[t._v("HTTP-header")]),t._v(" "),n("p",[t._v("HTTP-header 是客户端和服务器通讯时头部信息，对象 "),n("code",[t._v("xhr")]),t._v(" 有三种方法设置/读取自定义的 header，以发送附加的信息。")]),t._v(" "),n("p",[t._v("⚠️ "),n("a",{attrs:{href:"http://www.w3.org/TR/XMLHttpRequest/#the-setrequestheader-method",target:"_blank",rel:"noopener noreferrer"}},[t._v("一些 header 是由浏览器专门管理设置的"),n("OutboundLink")],1),t._v("，如 "),n("code",[t._v("Referer")]),t._v(" 和 "),n("code",[t._v("Host")]),t._v("，为了用户安全和请求的正确性不允通过对象 "),n("code",[t._v("xhr")]),t._v(" 的方法更改它们。")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("方法 "),n("code",[t._v("xhr.setRequestHeader(name, value)")]),t._v(" 使用给定的 "),n("code",[t._v("name")]),t._v(" 和 "),n("code",[t._v("value")]),t._v(" 设置 request header，必须在 "),n("code",[t._v("open()")]),t._v(" 之后、"),n("code",[t._v("send()")]),t._v(" 之前调用该方法。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setRequestHeader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("⚠️ "),n("code",[t._v("XMLHttpRequest")]),t._v(" 的一个特点是"),n("strong",[t._v("不能撤销 "),n("code",[t._v("setRequestHeader")])]),t._v("，即一旦设置了 header 就无法撤销了，其他调用会向 header 中添加信息，但不会覆盖它。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setRequestHeader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Auth'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'123'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setRequestHeader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Auth'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'456'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// header 将是：")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// X-Auth: 123, 456")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("方法 "),n("code",[t._v("getResponseHeader(name)")]),t._v(" 获取响应头中给定 "),n("code",[t._v("name")]),t._v(" 的 header（"),n("code",[t._v("Set-Cookie")]),t._v(" 和 "),n("code",[t._v("Set-Cookie2")]),t._v(" 除外）。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResponseHeader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("方法 "),n("code",[t._v("getAllResponseHeaders()")]),t._v(" 返回除 "),n("code",[t._v("Set-Cookie")]),t._v(" 和 "),n("code",[t._v("Set-Cookie2")]),t._v(" 外响应头中所有 response header。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// header 以单行形式返回")]),t._v("\nCache"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Control"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" max"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("age"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("31536000")]),t._v("\nContent"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Length"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4260")]),t._v("\nContent"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" image"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("png\nDate"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Sat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("08")]),t._v(" Sep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2012")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("53")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GMT")]),t._v("\n")])])]),n("p",[t._v("它们之间的换行符始终为 "),n("code",[t._v('"\\r\\n"')]),t._v("（不依赖于操作系统），而且"),n("code",[t._v("name")]),t._v(" 和 "),n("code",[t._v("value")]),t._v(" 之间总是以冒号后跟一个空格 "),n("code",[t._v('": "')]),t._v(" 分隔，基于这些标准格式可以很容易将它们拆分为单个 header。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将所有的 header 拆分为对象 result 的各个属性")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" headers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" xhr\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAllResponseHeaders")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\r\\n'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("reduce")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" current")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" current"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("': '")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// headers['Content-Type'] = 'image/png'")]),t._v("\n")])])])])]),t._v(" "),n("h3",{attrs:{id:"send-方法"}},[t._v("send() 方法")]),t._v(" "),n("p",[t._v("要实际地发送请求，需要调用 XHR "),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/send",target:"_blank",rel:"noopener noreferrer"}},[t._v("方法 "),n("code",[t._v(".send()")]),n("OutboundLink")],1),t._v("\n![发送 Ajax 请求](./_v_images/20200126161625614_20161.png =1000x)")]),t._v(" "),n("p",[t._v("虽然请求发出了，但如果不对响应事件作出监视，则请求成功或失败在都没有任何提示。为了监视事件可以设置 XHR 对象的 "),n("code",[t._v("onload")]),t._v(" 属性或 "),n("code",[t._v("onerror")]),t._v(" 属性。")]),t._v(" "),n("h4",{attrs:{id:"上传进度"}},[t._v("上传进度")]),t._v(" "),n("p",[t._v("事件 "),n("code",[t._v("progress")]),t._v(" 仅在下载阶段触发，可以通过监听该事件追踪下载过程。而对于上传过程可以监听 "),n("code",[t._v("xhr.upload")]),t._v(" 对象，上传过程中会在其上触发不同事件，通过监听这些事件可以追踪上传过程")]),t._v(" "),n("ul",[n("li",[t._v("事件 "),n("code",[t._v("loadstart")]),t._v(" 在上传开始时触发")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("progress")]),t._v(" "),n("strong",[t._v("在上传期间定期触发")])]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("abort")]),t._v(" 在上传中止触发")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("error")]),t._v(" 在非 HTTP 错误抛出时触发")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("load")]),t._v(" 在上传成功完成时触发")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("timeout")]),t._v(" （如果设置了 "),n("code",[t._v("timeout")]),t._v(" 属性）在上传超时时触发。")]),t._v(" "),n("li",[t._v("事件 "),n("code",[t._v("loadend")]),t._v(" 在上传完成时触发，无论成功还是 error。")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("upload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onprogress")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// event.loaded 表示已上传字节数，event.total 表示总字节数")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("Uploaded ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loaded"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v(" of ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("total"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v(" bytes")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("upload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("Upload finished successfully.")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("upload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onerror")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("Error during the upload: ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("具体的实例演示可查看："),n("a",{attrs:{href:"https://zh.javascript.info/xmlhttprequest#shang-chuan-jin-du",target:"_blank",rel:"noopener noreferrer"}},[t._v("带有进度指示的文件上传"),n("OutboundLink")],1)]),t._v(" "),n("h4",{attrs:{id:"跨域请求"}},[t._v("跨域请求")]),t._v(" "),n("p",[n("code",[t._v("XMLHttpRequest")]),t._v(" 可以使用 CORS 策略进行"),n("a",{attrs:{href:"#%E8%B7%A8%E6%BA%90%E8%AF%B7%E6%B1%82"}},[t._v("跨源请求")]),t._v("，要启用它们可以将属性 "),n("code",[t._v("xhr.withCredentials")]),t._v(" 设置为 "),n("code",[t._v("true")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" xhr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("withCredentials "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://anywhere.com/request'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])])]),n("h3",{attrs:{id:"中止请求"}},[t._v("中止请求")]),t._v(" "),n("p",[t._v("可以随时调用方法 "),n("code",[t._v("xhr.abort()")]),t._v(" 终止请求，它会触发 "),n("code",[t._v("abort")]),t._v(" 事件，且 "),n("code",[t._v("xhr.status")]),t._v(" 变为 "),n("code",[t._v("0")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("abort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 终止请求")]),t._v("\n")])])]),n("h3",{attrs:{id:"状态"}},[t._v("状态")]),t._v(" "),n("p",[t._v("对象 "),n("code",[t._v("xhr")]),t._v(" 的状态 state 会随着它的处理进度变化而变化，可以通过属性 "),n("code",[t._v("xhr.readyState")]),t._v(" 来了解当前状态。在"),n("a",{attrs:{href:"https://xhr.spec.whatwg.org/#states",target:"_blank",rel:"noopener noreferrer"}},[t._v("规范"),n("OutboundLink")],1),t._v(" 中提到的对象 "),n("code",[t._v("xhr")]),t._v(" 共有 5 个状态，分别用数值表示对应于一种状态，"),n("strong",[t._v("当对象 "),n("code",[t._v("xhr")]),t._v(" 状态发生变化时事件 "),n("code",[t._v("readystatechange")]),t._v(" 就会被触发")])]),t._v(" "),n("ul",[n("li",[n("code",[t._v("UNSENT = 0")]),t._v(" 初始状态")]),t._v(" "),n("li",[n("code",[t._v("OPENED = 1")]),t._v(" 方法 "),n("code",[t._v("open()")]),t._v(" 被调用")]),t._v(" "),n("li",[n("code",[t._v("HEADERS_RECEIVED = 2")]),t._v(" 接收到 response header")]),t._v(" "),n("li",[n("code",[t._v("LOADING = 3")]),t._v(" 响应正在被加载（接收到一个数据包）")]),t._v(" "),n("li",[n("code",[t._v("DONE = 4")]),t._v(" 请求完成")])]),t._v(" "),n("p",[t._v("在实际的网络请求过程中，对象 "),n("code",[t._v("xhr")]),t._v(" 状态以 "),n("code",[t._v("0")]),t._v(" → "),n("code",[t._v("1")]),t._v(" → "),n("code",[t._v("2")]),t._v(" → "),n("code",[t._v("3")]),t._v(" → … → "),n("code",[t._v("3")]),t._v(" → "),n("code",[t._v("4")]),t._v(" 的顺序转变，每当通过网络接收到一个数据包，就会重复一次状态 "),n("code",[t._v("3")]),t._v("。")]),t._v(" "),n("p",[t._v("💡 可以通过监听事件 "),n("code",[t._v("readystatechange")]),t._v("来跟踪该过程。可能在非常老的代码中找到 "),n("code",[t._v("readystatechange")]),t._v(" 这样的事件监听器，它的存在是有历史原因的，因为那时没有 "),n("code",[t._v("load")]),t._v(" 以及其他事件，如今它已被 "),n("code",[t._v("load/error/progress")]),t._v(" 事件处理程序所替代。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onreadystatechange")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readyState "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加载中")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readyState "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求完成")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h3",{attrs:{id:"响应"}},[t._v("响应")]),t._v(" "),n("p",[t._v("一旦服务器返回响应，我们访问 "),n("code",[t._v("xhr")]),t._v(" 对象的属性获取更详细的信息")]),t._v(" "),n("ul",[n("li",[t._v("属性 "),n("code",[t._v("status")]),t._v("HTTP 状态码（一个数字），如 "),n("code",[t._v("200")]),t._v("，"),n("code",[t._v("404")]),t._v("，"),n("code",[t._v("403")]),t._v(" 等，如果出现"),n("strong",[t._v("非 HTTP 错误")]),t._v("则为 "),n("code",[t._v("0")]),t._v("（如果是 HTTP 错误返回状态码是 "),n("code",[t._v("40*")]),t._v(" 形式）。")]),t._v(" "),n("li",[t._v("属性 "),n("code",[t._v("statusText")]),t._v(" HTTP 状态消息（一个字符串） 与状态码相对应，如 "),n("code",[t._v("200")]),t._v(" 对应于 "),n("code",[t._v("OK")]),t._v("，"),n("code",[t._v("404")]),t._v(" 对应于 "),n("code",[t._v("Not Found")]),t._v("，"),n("code",[t._v("403")]),t._v(" 对应于 "),n("code",[t._v("Forbidden")]),t._v(" 等。")]),t._v(" "),n("li",[t._v("属性 "),n("code",[t._v("response")]),t._v("（旧脚本可能用的是 "),n("code",[t._v("responseText")]),t._v("）服务器响应体 response body。")])]),t._v(" "),n("p",[t._v("⚠️ 请求返回像 "),n("code",[t._v("404")]),t._v(" 这样的 HTTP 错误响应，虽然无法获取资源也算是访问成功，依然可以调用 XHR 对象属性 "),n("code",[t._v("onload")]),t._v(" 设置的处理程序")]),t._v(" "),n("h4",{attrs:{id:"处理成功请求-onload"}},[t._v("处理成功请求 onload")]),t._v(" "),n("p",[t._v("XHR 对象 "),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestEventTarget/onload",target:"_blank",rel:"noopener noreferrer"}},[n("code",[t._v("onload")]),t._v(" 属性"),n("OutboundLink")],1),t._v("是请求成功完成时才调用的函数，通过该属性可以设置请求成功后的操作")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("XMLHttpRequest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onload "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// callback 是请求成功完成时要执行的函数，")]),t._v("\n")])])]),n("p",[t._v("💡 处理程序中的 "),n("code",[t._v("this")]),t._v(" 指代 XHR 对象")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求成功时将响应消息（如 HTML 文件）在终端打印出来")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleSuccess")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this 指代 XHR 对象")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this.responseText 保存来自服务器的响应内容")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseText"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nasyncRequestObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onload "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" handleSuccess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求成功时执行 handleSuccess 函数")]),t._v("\n")])])]),n("p",[t._v("⚠️ 使用 XHR 对象的 "),n("code",[t._v(".responseText")]),t._v(" 属性以获取响应的文本，如网页的 HTML 文件。")]),t._v(" "),n("h4",{attrs:{id:"处理错误-onerror"}},[t._v("处理错误 onerror")]),t._v(" "),n("p",[t._v("XHR 对象 "),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestEventTarget/onerror",target:"_blank",rel:"noopener noreferrer"}},[n("code",[t._v("onerror")]),t._v(" 属性"),n("OutboundLink")],1),t._v("是请求无法实现时才调用的函数，可以设置请求失败时执行的操作")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("XMLHttpRequest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onerror "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleError")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'出现错误 😞'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nasyncRequestObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onerror "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" handleError"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求失败时执行 handleError 函数")]),t._v("\n")])])]),n("h4",{attrs:{id:"响应类型"}},[t._v("响应类型")]),t._v(" "),n("p",[t._v("除了访问服务器获取网站的 HTML 文件之外，还可以获取其他格式的数据。可以使用 "),n("code",[t._v("xhr")]),t._v(" 对象属性 "),n("code",[t._v("xhr.responseType")]),t._v(" （预先，使用方法 "),n("code",[t._v("xhr.send()")]),t._v(" 发送请求之前）设置响应格式，以便 JavaScript 对响应体进行合适的处理：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v('""')]),t._v("（默认） 响应格式为字符串，")]),t._v(" "),n("li",[n("code",[t._v('"text"')]),t._v(" 响应格式为字符串，")]),t._v(" "),n("li",[n("code",[t._v('"arraybuffer"')]),t._v(" 响应格式为 "),n("code",[t._v("ArrayBuffer")])]),t._v(" "),n("li",[n("code",[t._v('"blob"')]),t._v(" 响应格式为 "),n("code",[t._v("Blob")])]),t._v(" "),n("li",[n("code",[t._v('"document"')]),t._v(" 响应格式为 XML document（可以使用 XPath 和其他 XML 方法）")]),t._v(" "),n("li",[n("code",[t._v('"json"')]),t._v(" 响应格式为 JSON（自动解析）"),n("RouterLink",{attrs:{to:"/web/Network/JSON.html"}},[t._v("JSON")]),t._v(" 是网络传输常见的数据格式")],1)]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" xhr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/article/xmlhttprequest/example/json'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 预设返回数据类型")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseType "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'json'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 由于预设了返回的数据类型为 JSON，JavaScript 自动解析响应")]),t._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" responseObj "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" xhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("responseObj"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Hello, world!")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("也可以使用 JavaScript 内建的函数 "),n("code",[t._v("JSON.parse()")]),t._v(" （手动）解析 JSON 数据并转换为 JavaScript 对象。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleSuccess")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用函数 JSON.parse() 将数据从 JSON 格式转换为 JavaScript 对象")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseText "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" data "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nasyncRequestObject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onload "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" handleSuccess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("💡 在旧的脚本中，可能会看到 "),n("code",[t._v("xhr.responseText")]),t._v("，甚至会看到 "),n("code",[t._v("xhr.responseXML")]),t._v(" 属性。它们是由于历史原因而存在的，以获取字符串或 XML 文档。如今应该通过属性 "),n("code",[t._v("xhr.responseType")]),t._v(" 设置格式，然后就可以直接使用通用的属性 "),n("code",[t._v("xhr.response")]),t._v(" 访问不同数据。")]),t._v(" "),n("h2",{attrs:{id:"fetch"}},[t._v("fetch")]),t._v(" "),n("p",[t._v("参考： "),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 Fetch - Web API 接口参考 | MDN"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("现代通用的发送网络请求的方法是 Fetch，这是新的 JavaScript API 旨在让资源请求（通常是网络请求）简单很多，"),n("strong",[t._v("其核心是基于 "),n("code",[t._v("promise")]),t._v(" 处理异步请求")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" promise "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("参数说明：")]),t._v(" "),n("ul",[n("li",[n("strong",[n("code",[t._v("url")])]),t._v(" 要访问的 URL。")]),t._v(" "),n("li",[n("strong",[n("code",[t._v("options")])]),t._v(" 可选参数，是一个称为 init 对象/配置对象，具有属性 "),n("code",[t._v("method")]),t._v("，"),n("code",[t._v("header")]),t._v(" 等，用于设置 HTTP 请求的头部信息。")])]),t._v(" "),n("p",[t._v("典型的 fetch 请求由两个 "),n("code",[t._v("await")]),t._v(" 调用组成或以 "),n("code",[t._v("promise")]),t._v(" 形式")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 形式一：使用 await 关键字")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 解析 response header")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将 body 读取为 json")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 形式二：使用 promise 链式调用")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("response")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("result")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* process result */")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("通过 Fetch 发送请求并处理响应的过程：")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("创建 "),n("code",[t._v("fetch(url)")]),t._v(" 函数并提供了 "),n("code",[t._v("url")]),t._v(" 后浏览器会立即向服务器发送网络请求，（无论请求成功与否）并立即返回一个 "),n("RouterLink",{attrs:{to:"/web/JavaScript/语法基础/promise.html"}},[t._v("Promise 对象")])],1)]),t._v(" "),n("li",[n("p",[t._v("当服务器返回响应头 response header 时，"),n("code",[t._v("promise")]),t._v(" 对象就使用内建的 "),n("a",{attrs:{href:"https://fetch.spec.whatwg.org/#response-class",target:"_blank",rel:"noopener noreferrer"}},[t._v("Response"),n("OutboundLink")],1),t._v(" class 对象来对响应头进行解析，通过响应头来检查 HTTP 状态以确定请求是否成功（当前还没有响应体 response body）。")]),t._v(" "),n("ul",[n("li",[t._v("如果 "),n("code",[t._v("fetch")]),t._v(" 无法建立一个 HTTP 请求，如网络问题或是请求的网址不存在，就会抛出错误，即 "),n("code",[t._v("promise")]),t._v(" 就会 reject")]),t._v(" "),n("li",[t._v("如果请求成功 "),n("code",[t._v("promise")]),t._v(" 就会 resolve，则可以访问 "),n("strong",[n("code",[t._v("response")]),t._v(" 对象的属性 "),n("code",[t._v("status")]),t._v("，属性值会在特定范围中，如 "),n("code",[t._v("200")])]),t._v("；如果 HTTP 状态码 200-299，则 "),n("code",[t._v("request")]),t._v(" 对象的属性 "),n("code",[t._v("ok")]),t._v(" 为 "),n("code",[t._v("true")])])]),t._v(" "),n("p",[t._v("⚠️ 异常的 HTTP 状态，如响应头 "),n("code",[t._v("status")]),t._v(" 为 "),n("code",[t._v("404")]),t._v(" 或 "),n("code",[t._v("500")]),t._v(" 也是请求成功的一种情况，所以不会导致出现 "),n("code",[t._v("error")])])]),t._v(" "),n("li",[n("p",[t._v("基于 "),n("code",[t._v("promise")]),t._v(" 对象的状态通过链式调用执行"),n("strong",[t._v("方法 "),n("code",[t._v("then()")]),t._v(" 或 "),n("code",[t._v("catch()")])]),t._v("，如果请求成功就会返回 "),n("code",[t._v("response")]),t._v(" 对象，可基于 response body 的数据格式调用 "),n("code",[t._v("response")]),t._v(" 对象的"),n("a",{attrs:{href:"#%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"}},[t._v("不同方法")]),t._v("进行解析。")])])]),t._v(" "),n("p",[t._v("💡 可访问 "),n("a",{attrs:{href:"http://caniuse.com/#feat=fetch",target:"_blank",rel:"noopener noreferrer"}},[t._v("caniuse"),n("OutboundLink")],1),t._v(" 查看当前浏览器是否支持 Fetch API，如果你的浏览器不支持只需向你的项目中添加 "),n("a",{attrs:{href:"https://github.com/github/fetch",target:"_blank",rel:"noopener noreferrer"}},[t._v("polyfill"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("⚠️ Fetch 请求依然需要遵守"),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy",target:"_blank",rel:"noopener noreferrer"}},[t._v("同源策略"),n("OutboundLink")],1),t._v("的限制，默认情况下只能对与加载数据在同一网域中的资源和数据发出请求。")]),t._v(" "),n("h3",{attrs:{id:"request-header"}},[t._v("Request header")]),t._v(" "),n("p",[t._v("在函数 "),n("code",[t._v("fetch()")]),t._v(" 的第二个参数（可选）配置对象的属性 "),n("code",[t._v("header")]),t._v(" 中设置 HTTP 请求的头部信息")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'key'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" value\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("💡 可以使用 Fetch API 提供的接口/构造函数 "),n("code",[t._v("Headers")]),t._v(" 创建一个 HTTP 请求头，一般步骤是")]),t._v(" "),n("ol",[n("li",[t._v("使用构造函数 "),n("code",[t._v("Header()")]),t._v(" 创建新 "),n("code",[t._v("header")]),t._v(" 对象")]),t._v(" "),n("li",[t._v("（以键值对的形式，类似于 Map）通过 "),n("code",[t._v("append()")]),t._v(" 方法将信息添加到 "),n("code",[t._v("header")]),t._v(" 对象中")]),t._v(" "),n("li",[t._v("将该 "),n("code",[t._v("header")]),t._v(" 对象作为（"),n("code",[t._v("fetch()")]),t._v(" 函数的第二个参数）配置对象的属性 "),n("code",[t._v("headers")]),t._v(" 的值")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" requestHeaders "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Headers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrequestHeaders"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'key'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" requestHeaders\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("⚠️ 有一些 header 对象的属性无法设置，这些 header 属性保证了 HTTP 的正确性和安全性，所以它们仅由浏览器控制，详见 "),n("a",{attrs:{href:"https://fetch.spec.whatwg.org/#forbidden-header-name",target:"_blank",rel:"noopener noreferrer"}},[t._v("forbidden HTTP headers"),n("OutboundLink")],1)]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Accept-Charset")]),t._v(", "),n("code",[t._v("Accept-Encoding")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Request-Headers")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Request-Method")])]),t._v(" "),n("li",[n("code",[t._v("Connection")])]),t._v(" "),n("li",[n("code",[t._v("Content-Length")])]),t._v(" "),n("li",[n("code",[t._v("Cookie")]),t._v(", "),n("code",[t._v("Cookie2")])]),t._v(" "),n("li",[n("code",[t._v("Date")])]),t._v(" "),n("li",[n("code",[t._v("DNT")])]),t._v(" "),n("li",[n("code",[t._v("Expect")])]),t._v(" "),n("li",[n("code",[t._v("Host")])]),t._v(" "),n("li",[n("code",[t._v("Keep-Alive")])]),t._v(" "),n("li",[n("code",[t._v("Origin")])]),t._v(" "),n("li",[n("code",[t._v("Referer")])]),t._v(" "),n("li",[n("code",[t._v("TE")])]),t._v(" "),n("li",[n("code",[t._v("Trailer")])]),t._v(" "),n("li",[n("code",[t._v("Transfer-Encoding")])]),t._v(" "),n("li",[n("code",[t._v("Upgrade")])]),t._v(" "),n("li",[n("code",[t._v("Via")])]),t._v(" "),n("li",[n("code",[t._v("Proxy-*")])]),t._v(" "),n("li",[n("code",[t._v("Sec-*")])])]),t._v(" "),n("h4",{attrs:{id:"fetch-api"}},[t._v("Fetch API")]),t._v(" "),n("p",[t._v("fetch 提供"),n("a",{attrs:{href:"https://zh.javascript.info/fetch-api",target:"_blank",rel:"noopener noreferrer"}},[t._v("多种选项"),n("OutboundLink")],1),t._v("以更好地配置网络请求")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" promise "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// POST，PUT，DELETE，等。")]),t._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内容类型 header 值通常是自动设置的")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取决于 request body")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text/plain;charset=UTF-8"')]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// string，FormData，Blob，BufferSource，或 URLSearchParams")]),t._v("\n  referrer"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"about:client"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 或 "" 以不发送 Referer header，')]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 或者是当前源的 url")]),t._v("\n  referrerPolicy"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"no-referrer-when-downgrade"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// no-referrer，origin，same-origin...")]),t._v("\n  mode"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cors"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// same-origin，no-cors")]),t._v("\n  credentials"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"same-origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// omit，include")]),t._v("\n  cache"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// no-store，reload，no-cache，force-cache，或 only-if-cached")]),t._v("\n  redirect"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"follow"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// manual，error")]),t._v("\n  integrity"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 一个 hash，像 "sha256-abcdef1234567890"')]),t._v("\n  keepalive"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// true")]),t._v("\n  signal"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// AbortController 来中止请求")]),t._v("\n  window"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" window "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// null")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h4",{attrs:{id:"更改-http-方法"}},[t._v("更改 HTTP 方法")]),t._v(" "),n("p",[t._v("Fetch 请求的默认 HTTP 方法是 GET，可以通过 "),n("code",[t._v("fetch()")]),t._v(" 的配置对象的属性 "),n("code",[t._v("method")]),t._v(" 设置其他的 HTTP 方法")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 POST 方法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("如果使用 POST 发送网络请求，则需要提供 请求体 request body，通过 "),n("code",[t._v("fetch()")]),t._v(" 的配置对象的属性 "),n("code",[t._v("body")]),t._v(" 进行设置")]),t._v(" "),n("p",[n("strong",[n("code",[t._v("body")])]),t._v(" 属性值可以有多种数据类型，常见的格式如下：")]),t._v(" "),n("ul",[n("li",[t._v("字符串，一般以 JSON 格式进行编码（最常用）")]),t._v(" "),n("li",[n("code",[t._v("FormData")]),t._v(" 对象，以 "),n("code",[t._v("form/multipart")]),t._v(" 形式发送数据")]),t._v(" "),n("li",[n("code",[t._v("Blob")]),t._v("/"),n("code",[t._v("BufferSource")]),t._v(" 发送二进制数据")]),t._v(" "),n("li",[n("a",{attrs:{href:"https://zh.javascript.info/url",target:"_blank",rel:"noopener noreferrer"}},[t._v("URLSearchParams"),n("OutboundLink")],1),t._v(" 以 "),n("code",[t._v("x-www-form-urlencoded")]),t._v(" 编码形式发送数据（很少使用）")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 以 JSON 形式发送 user 对象")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" user "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'John'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  surname"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Smith'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/article/fetch/post/user'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json;charset=utf-8'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// User saved.")]),t._v("\n")])])]),n("p",[t._v("💡 请注意如果请求的 "),n("code",[t._v("body")]),t._v(" 是字符串，则 "),n("code",[t._v("Content-Type")]),t._v(" 会默认设置为 "),n("code",[t._v("text/plain;charset=UTF-8")]),t._v("；但是当要发送 JSON 时，需要将 "),n("code",[t._v("headers")]),t._v(" 的属性 "),n("code",[t._v("Content-Type")]),t._v(" 设置为 "),n("code",[t._v("application/json")]),t._v("，因为这是 JSON 编码的数据的正确的 "),n("code",[t._v("Content-Type")]),t._v("。")]),t._v(" "),n("h4",{attrs:{id:"formdata"}},[t._v("FormData")]),t._v(" "),n("p",[t._v("在商业网站中最常见和实用的数据传输/请求就是表单数据，使用 "),n("a",{attrs:{href:"https://xhr.spec.whatwg.org/#interface-formdata",target:"_blank",rel:"noopener noreferrer"}},[t._v("FormData"),n("OutboundLink")],1),t._v(" 对象可以提供帮助。")]),t._v(" "),n("p",[t._v("FormData 是 HTML 表单数据的对象，通过构造函数 "),n("code",[t._v("FormData()")]),t._v(" 创建，可以提供 HTML 元素 "),n("code",[t._v("form")]),t._v(" 作为其参数，这样 FormData 对象会自动捕抓其中的表单字段/控件。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" formData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("form"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("💡 向服务器传递 "),n("code",[t._v("FormData")]),t._v(" 对象时，如使用方法"),n("code",[t._v("fetch()")]),t._v("（将其设置为函数 "),n("code",[t._v("fetch()")]),t._v(" 的第二个参数配置对象的属性 "),n("code",[t._v("body")]),t._v(" 值），它会被编码并发送出去（这个编码允许发送文件，因此 "),n("code",[t._v('<input type="file">')]),t._v(" 字段也能被发送），并带有 "),n("code",[t._v("Content-Type: multipart/form-data")]),t._v("（因此不需要设置 "),n("code",[t._v("fetch()")]),t._v(" 第二个参数对象的属性 "),n("code",[t._v("Content-Type")]),t._v("），这样从服务器角度来看，它就像是一个普通的表单提交。")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("form")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("formElem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("text"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("John"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("text"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("surname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Smith"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("submit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("form")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  formElem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onsubmit")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("preventDefault")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/article/formdata/post/user'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("formElem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送表单 formElem")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("p",[t._v("可以使用以下方法修改 "),n("code",[t._v("FormData")]),t._v(" 中的字段/控件")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("formData.append(name, value)")]),t._v(" 添加具有给定 "),n("code",[t._v("name")]),t._v(" 和 "),n("code",[t._v("value")]),t._v(" 的表单字段，")]),t._v(" "),n("li",[n("code",[t._v("formData.append(name, blob, fileName)")]),t._v(" 添加一个文件类型字段（动态生成的二进制数据），相当于 "),n("code",[t._v('<input type="file">')]),t._v("，第三个参数 "),n("code",[t._v("fileName")]),t._v(" 设置文件名（而不是表单字段名），它是用户文件系统中文件的名称")]),t._v(" "),n("li",[n("code",[t._v("formData.delete(name)")]),t._v(" 移除带有给定 "),n("code",[t._v("name")]),t._v(" 的字段")]),t._v(" "),n("li",[n("code",[t._v("formData.get(name)")]),t._v(" 获取带有给定 "),n("code",[t._v("name")]),t._v(" 的字段值")]),t._v(" "),n("li",[n("code",[t._v("formData.has(name)")]),t._v(" 如果存在带有给定 "),n("code",[t._v("name")]),t._v(" 的字段，则返回 "),n("code",[t._v("true")]),t._v("，否则返回 "),n("code",[t._v("false")])])]),t._v(" "),n("p",[t._v("💡 从技术上来讲，一个表单可以包含多个具有相同 "),n("code",[t._v("name")]),t._v(" 的字段，因此多次调用 "),n("code",[t._v("append")]),t._v(" 将会添加多个具有相同名称的字段。")]),t._v(" "),n("p",[t._v("而类似于 "),n("code",[t._v("append")]),t._v(" 的方法 "),n("code",[t._v("set")]),t._v(" "),n("strong",[t._v("移除所有具有给定 "),n("code",[t._v("name")]),t._v(" 的字段，然后附加一个新字段")]),t._v("，因此它确保了只有一个具有这种 "),n("code",[t._v("name")]),t._v(" 的字段")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("formData.set(name, value)")]),t._v("，")]),t._v(" "),n("li",[n("code",[t._v("formData.set(name, blob, fileName)")]),t._v("。")])]),t._v(" "),n("p",[t._v("💡 可以使用 "),n("code",[t._v("for..of")]),t._v(" 循环迭代 formData 字段")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" formData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nformData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'key1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'value1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nformData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'key2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'value2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过解构获取 key/value 对")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("of")]),t._v(" formData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v(" = ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("value"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// key1=value1，然后是 key2=value2")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"下载进度"}},[t._v("下载进度")]),t._v(" "),n("p",[t._v("通过方法 "),n("code",[t._v("fetch()")]),t._v(" 发送的网络请求，支持使用 "),n("code",[t._v("response.body")]),t._v(" 的方法跟踪下载进度，"),n("code",[t._v("response.body")]),t._v(" 是 "),n("a",{attrs:{href:"https://streams.spec.whatwg.org/#rs-class",target:"_blank",rel:"noopener noreferrer"}},[n("code",[t._v("ReadableStream")]),t._v(" 对象"),n("OutboundLink")],1),t._v("，类似于 与 "),n("code",[t._v("response.text()")]),t._v("，"),n("code",[t._v("response.json()")]),t._v(" 和其他方法可读取响应体，但 "),n("code",[t._v("response.body")]),t._v(" 可以通过方法，如 "),n("code",[t._v("read()")]),t._v(" 逐块 chunk 读取并监控下载进度。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建一个流读取器 stream reader 读取响应体，代替 response.json() 以及其他方法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" reader "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在循环中接收响应块 response chunk，并读取每次接受块字节的大小，直到加载完成")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当最后一块下载完成时，done 值为 true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// value 是块字节")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("done"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" reader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("done"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("Received ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v(" bytes")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("更详细地控制下载进度（并将响应块「复原」为响应体）的实例可查看 "),n("a",{attrs:{href:"https://zh.javascript.info/fetch-progress",target:"_blank",rel:"noopener noreferrer"}},[t._v("Fetch：下载进度"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("💡 到目前为止方法 "),n("code",[t._v("fetch")]),t._v(" 无法跟踪上传进度，可使用方法 "),n("code",[t._v("XMLHttpReques")]),t._v(" 发送网络请求以监听上传进度")]),t._v(" "),n("h3",{attrs:{id:"中止请求-2"}},[t._v("中止请求")]),t._v(" "),n("p",[t._v("方法 "),n("code",[t._v("fetch")]),t._v(" 核心是基于 promise 处理网络请求，如果想中止网络请求，但在 JavaScript 通常并没有「中止」 promise 的概念，我们可以借用特殊的内建对象 AbortController 来实现。")]),t._v(" "),n("p",[t._v("内建对象 AbortController 可用于中止异步任务，包括 "),n("code",[t._v("fetch()")]),t._v(" 发起的网络请求。使用构建函数 "),n("code",[t._v("AbortController")]),t._v(" 创建控制器，该对象只有单一的方法 "),n("code",[t._v("abort()")]),t._v(" 和单一属性 "),n("code",[t._v("signal")]),t._v("。")]),t._v(" "),n("p",[t._v("当控制器调用 "),n("code",[t._v("abort()")]),t._v(" 方法时，事件 "),n("code",[t._v("abort")]),t._v(" 就会在 "),n("code",[t._v("controller.signal")]),t._v(" 上触发，同时 "),n("code",[t._v("controller.signal.aborted")]),t._v(" 属性变为 "),n("code",[t._v("true")]),t._v("。因此可以在 "),n("code",[t._v("controller.signal")]),t._v(" 上设置监听器来跟踪事件 "),n("code",[t._v("abort")]),t._v("，并执行相应的处理程序中止 "),n("code",[t._v("promise")]),t._v("；而方法 "),n("code",[t._v("fetch")]),t._v(" 在内部集成了它，只要将 "),n("code",[t._v("controller.signal")]),t._v(" 作为函数 "),n("code",[t._v("fetch()")]),t._v(" 的第二个参数配置对象的属性 "),n("code",[t._v("signal")]),t._v(" 的值即可实现监控。")]),t._v(" "),n("p",[t._v("中止方法 "),n("code",[t._v("fetch")]),t._v(" 发起的网络请求步骤：")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("创建一个控制器")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbortController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("将 "),n("code",[t._v("signal")]),t._v(" 属性传递给 "),n("code",[t._v("fetch")]),t._v(" 选项，它会监听 "),n("code",[t._v("signal")]),t._v(" 上的事件 "),n("code",[t._v("abort")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbortController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  signal"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signal\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("调用 "),n("code",[t._v("controller.abort()")]),t._v(" 来中止")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("abort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])]),t._v(" "),n("p",[t._v("💡 当一个异步程序被中止时，promise 就会变成 reject 状态并返回一个 "),n("code",[t._v("AbortError")]),t._v(" 异常，我们可以捕抓该异常并对其进行处理。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1 秒后中止")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbortController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("abort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/article/fetch-abort/demo/hang'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    signal"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signal\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'AbortError'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle abort()")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Aborted!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("💡 AbortController 是"),n("strong",[t._v("可扩展")]),t._v("的，即控制器可以分配给多个 fetch 或其他异步任务（需要手动设置监听器来监听事件 "),n("code",[t._v("abort")]),t._v(" 触发 promise 状态变成 reject），实现一次中止多个网络请求。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" urls "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 要并行 fetch 的 url 列表")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbortController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" ourJob "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 其他异步任务")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'abort'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置事件 abort 监听器")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" fetchJobs "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" urls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("url")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// fetches")]),t._v("\n  signal"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signal\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 等待完成所有异步任务任务和 fetch 发起的网络请求")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" results "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("all")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("fetchJobs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ourJob"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果 controller.abort() 被从其他地方调用，")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 它将中止所有 fetch 和 ourJob")]),t._v("\n")])])]),n("h3",{attrs:{id:"处理程序"}},[t._v("处理程序")]),t._v(" "),n("p",[t._v("Fetch 基于 Promise，当我们发出 Fetch 请求时，它将自动返回一个 promise 对象，我们可以对其进行监听响应，即通过链式调用为该 promise 对象设置方法 "),n("code",[t._v("then()")]),t._v(" 或 "),n("code",[t._v("catch()")])]),t._v(" "),n("p",[t._v("当 Fetch 请求 "),n("code",[t._v("resolve")]),t._v(" 时就会将 "),n("code",[t._v("Response")]),t._v(" 对象作为 promise 对象的结果，同时会调用 "),n("code",[t._v(".then()")]),t._v(" 方法执行处理程序；如果请求发生错误就会调用 "),n("code",[t._v(".catch()")]),t._v(" 方法并执行处理程序。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当响应的主体数据格式为 JSON 时，对响应对象调用方法 json()")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("response")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// response 为响应对象，从中提取响应（主体）数据")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("💡 "),n("code",[t._v("Response")]),t._v(" 对象上有多种基于 promise 的"),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch#Body",target:"_blank",rel:"noopener noreferrer"}},[t._v("方法"),n("OutboundLink")],1),t._v("，每个方法对应处理"),n("a",{attrs:{href:"https://davidwalsh.name/fetch",target:"_blank",rel:"noopener noreferrer"}},[t._v("不同数据类型"),n("OutboundLink")],1),t._v("以访问 response body")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("response.json()")]),t._v(" 将 response 解析为 JSON")]),t._v(" "),n("li",[n("code",[t._v("response.text()")]),t._v(" 读取 response，并以文本形式返回 response")]),t._v(" "),n("li",[n("code",[t._v("response.blob()")]),t._v(" 以 "),n("a",{attrs:{href:"https://zh.javascript.info/blob",target:"_blank",rel:"noopener noreferrer"}},[t._v("Blob"),n("OutboundLink")],1),t._v("（具有类型的二进制数据）形式返回，如图片文件")]),t._v(" "),n("li",[n("code",[t._v("response.formData()")]),t._v(" 以 "),n("code",[t._v("FormData")]),t._v(" 对象的形式返回 response")]),t._v(" "),n("li",[n("code",[t._v("response.arrayBuffer()")]),t._v(" 以 "),n("a",{attrs:{href:"https://zh.javascript.info/arraybuffer-binary-arrays",target:"_blank",rel:"noopener noreferrer"}},[t._v("ArrayBuffer"),n("OutboundLink")],1),t._v("（低级别的二进制数据）形式返回 response")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 promise 链式调用获取 JSON 格式的 response body")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("response")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("commits")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("commits"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("author"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("login"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*---------- 分割线 ----------*/")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 awite 方法，获取 JSON 格式的 response body")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" commits "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 读取 response body，并将其解析为 JSON")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("commits"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("author"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("login"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*---------- 分割线 ----------*/")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用方法 response.text() 获取纯文本格式的 response body")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" text "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("text")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将 response body 读取为文本")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'...'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 截取前80个字符")]),t._v("\n")])])]),n("p",[t._v("⚠️ 只能选择一种读取 body 的方法，如使用了 "),n("code",[t._v("response.text()")]),t._v(" 方法来获取 response，那么如果再用 "),n("code",[t._v("response.json()")]),t._v(" 则不会生效，因为 body 内容已经被处理过了。")]),t._v(" "),n("h3",{attrs:{id:"response-header"}},[t._v("Response header")]),t._v(" "),n("p",[t._v("使用响应对象属性 "),n("code",[t._v("response.headers")]),t._v(" 访问 Response header 响应表头，它类似于 Map （但不是真正的 Map）具有类似的方法，即按键/名称 name 获取各个值 header，或使用循环结构迭代其中的元素。")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[t._v("let response = await fetch('https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits');\n\n// 获取一个 header\nalert(response.headers.get('Content-Type')); // application/json; charset=utf-8\n\n// 迭代所有 header\nfor (let [key, value] of response.headers) {\n  alert(`${key} = ${value}`);\n}\n")])])]),n("h2",{attrs:{id:"跨源请求"}},[t._v("跨源请求")]),t._v(" "),n("p",[t._v("Cross-Origin Resource Sharing，CORS 跨源资源共享是指那些发送到其他域（即使是子域）、协议或端口的请求，需要远程服务器必须提供表示允许获取的 header "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v("。")]),t._v(" "),n("p",[t._v("💡 这里的源 origin 包括域 domain/端口 port/协议 protocol 的组合，只要网络请求中其中之一与目前加载数据来源不同就是"),n("strong",[t._v("跨源")]),t._v("。起初出于安全考虑跨源请求 CORS 是被禁止的，为了保护互联网以免受黑客攻击，如位于 https://facebook.com 的脚本无法读取位于 https://gmail.com 的用户邮箱的内容。但为了资源互通流动需要在必要时打破这种限制，经过长时间的讨论跨源请求被允许了，但是任何新功能都需要服务器明确允许，即服务器必须提供表示允许获取的 header "),n("code",[t._v("Access-Control-Allow-Origin")])]),t._v(" "),n("p",[t._v("有两种类型的跨域请求：简单的请求和所有其他请求。"),n("strong",[t._v("本质区别在于，可以使用 "),n("code",[t._v("<form>")]),t._v(" 或 "),n("code",[t._v("<script>")]),t._v(" 进行「简单请求」，而无需任何其他特殊方法。")])]),t._v(" "),n("h3",{attrs:{id:"简单请求"}},[t._v("简单请求")]),t._v(" "),n("p",[t._v("一个 "),n("a",{attrs:{href:"http://www.w3.org/TR/cors/#terminology",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单的请求"),n("OutboundLink")],1),t._v(" 是指满足以下两个条件的请求")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"http://www.w3.org/TR/cors/#simple-method",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单的方法"),n("OutboundLink")],1),t._v(" "),n("code",[t._v("GET")]),t._v("，"),n("code",[t._v("POST")]),t._v(" 或 "),n("code",[t._v("HEAD")])]),t._v(" "),n("li",[n("a",{attrs:{href:"http://www.w3.org/TR/cors/#simple-header",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单的 header"),n("OutboundLink")],1),t._v(" 仅允许自定义下列 header：\n"),n("ul",[n("li",[n("code",[t._v("Accept")]),t._v("，")]),t._v(" "),n("li",[n("code",[t._v("Accept-Language")]),t._v("，")]),t._v(" "),n("li",[n("code",[t._v("Content-Language")]),t._v("，")]),t._v(" "),n("li",[n("code",[t._v("Content-Type")]),t._v(" 的值为 "),n("code",[t._v("application/x-www-form-urlencoded")]),t._v("，"),n("code",[t._v("multipart/form-data")]),t._v(" 或 "),n("code",[t._v("text/plain")]),t._v("。")])])])]),t._v(" "),n("p",[t._v("如果一个请求是跨源的，浏览器始终会向 HTTP 请求添加 "),n("code",[t._v("Origin")]),t._v(" header，它包含了确切的源 domain/protocol/port 但没有路径。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从 https://javascript.info/page 请求 https://anywhere.com/request 的 header")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("request\nHost"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" anywhere"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com\nOrigin"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" https"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),n("p",[t._v("然后服务器接收到该请求时可以检查 "),n("code",[t._v("Origin")]),t._v("，如果同意接受这样的请求，就会在响应中添加一个特殊的 header "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v("，该 header 包含了允许的源（在我们的示例中是 "),n("code",[t._v("https://javascript.info")]),t._v("）或者一个星号 "),n("code",[t._v("*")]),t._v("，然后响应成功，否则报错。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 带有服务器许可的响应")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OK")]),t._v("\nContent"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" charset"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UTF")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\nAccess"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Control"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Allow"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Origin"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" https"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info\n")])])]),n("p",[t._v("对于跨源请求，默认情况下 JavaScript 只能访问「简单」response header，访问任何其他 response header 都将导致 "),n("code",[t._v("error")])]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Cache-Control")])]),t._v(" "),n("li",[n("code",[t._v("Content-Language")])]),t._v(" "),n("li",[n("code",[t._v("Content-Type")])]),t._v(" "),n("li",[n("code",[t._v("Expires")])]),t._v(" "),n("li",[n("code",[t._v("Last-Modified")])]),t._v(" "),n("li",[n("code",[t._v("Pragma")])])]),t._v(" "),n("p",[t._v("⚠️ 上述列表中没有 "),n("code",[t._v("Content-Length")]),t._v(" header，它包含完整的响应长度用于跟踪下载进度百分比。要授予 JavaScript 对任何其他 response header 的访问权限，服务器必须发送 "),n("code",[t._v("Access-Control-Expose-Headers")]),t._v(" 的 header，它包含一个以逗号分隔的应该被设置为可访问的非简单 header 名称列表。")]),t._v(" "),n("p",[t._v("浏览器扮演受被信任的中间人的角色，决定是否允许跨源请求的发送：")]),t._v(" "),n("ul",[n("li",[t._v("它确保发送的跨源请求带有正确的 "),n("code",[t._v("Origin")])]),t._v(" "),n("li",[t._v("它检查响应中的许可 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 是否存在，如果存在则允许 JavaScript 访问响应，否则将失败并报错")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(1112),alt:"CORS"}})]),t._v(" "),n("h3",{attrs:{id:"非简单请求"}},[t._v("非简单请求")]),t._v(" "),n("p",[t._v("除了满足简单请求限制的两种条件的请求以外，任何其他请求都被认为是「非简单请求」，如具有 "),n("code",[t._v("PUT")]),t._v(" 方法或 "),n("code",[t._v("API-Key")]),t._v(" HTTP-header 的请求。")]),t._v(" "),n("p",[t._v("之前没有人能够设想网页能发出这些复杂的非简单请求，因此当我们尝试发送一个非简单请求时，"),n("strong",[t._v("浏览器会发送一个特殊的「预检」preflight 请求到服务器")]),t._v("，以询问服务器是否接受此类跨源请求，除非服务器明确通过 header 进行确认，否则非简单请求不会被发送。")]),t._v(" "),n("p",[t._v("预检请求使用 "),n("code",[t._v("OPTIONS")]),t._v(" 方法，它没有 body，但是有两个 header：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Access-Control-Request-Method")]),t._v(" header 带有非简单请求的方法。")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Request-Headers")]),t._v(" header 提供一个以逗号分隔的非简单 HTTP-header 列表。")])]),t._v(" "),n("p",[t._v("如果服务器同意处理请求那么它会进行响应，此响应的状态码应该为 "),n("code",[t._v("200")]),t._v("，没有 body，具有 header：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Access-Control-Allow-Methods")]),t._v(" 必须具有允许的方法。")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Headers")]),t._v(" 必须具有一个允许的 header 列表。")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Max-Age")]),t._v(" header 可以指定缓存此权限的秒数，因此浏览器不是必须为满足给定权限的后续请求发送预检。")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(1113),alt:"No-simple requests"}})]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送非简单请求")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://site.com/service.json'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'PATCH'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 方法 PATCH 并非简单请求限制三个中之一")]),t._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Content-Type 不是简单请求限制三个中之一")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'API-Key'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'secret'")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 含有 API-Key header")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("非简单跨域请求步骤：")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("在发送请求前，浏览器会自己发送预检请求 preflight request")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OPTIONS")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json\nHost"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com\nOrigin"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" https"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info\nAccess"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Control"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Request"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PATCH")]),t._v("\nAccess"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Control"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Request"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Content"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Type"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("API")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Key\n")])])]),n("ul",[n("li",[t._v("方法："),n("code",[t._v("OPTIONS")])]),t._v(" "),n("li",[t._v("路径与主请求完全相同："),n("code",[t._v("/service.json")])]),t._v(" "),n("li",[t._v("特殊跨源头：\n"),n("ul",[n("li",[n("code",[t._v("Origin")]),t._v(" 来源。")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Request-Method")]),t._v(" 请求方法。")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Request-Headers")]),t._v(" 以逗号分隔的「非简单」header 列表。")])])])]),t._v(" "),n("p",[t._v("💡 预检请求发生在后台，它对 JavaScript 不可见。JavaScript 仅获取对主请求的响应，如果没有服务器许可，则获得一个 error。")])]),t._v(" "),n("li",[n("p",[t._v("服务应返回预检响应")]),t._v(" "),n("p",[t._v("当服务应响应状态 "),n("code",[t._v("200")]),t._v(" 并包括以下 header 就表示允许后续通信，否则会触发错误。")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Access-Control-Allow-Methods: PATCH")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Headers: Content-Type,API-Key")]),t._v("。")])]),t._v(" "),n("p",[t._v("当浏览器看到 "),n("code",[t._v("PATCH")]),t._v(" 在 "),n("code",[t._v("Access-Control-Allow-Methods")]),t._v(" 中，"),n("code",[t._v("Content-Type,API-Key")]),t._v(" 在列表 "),n("code",[t._v("Access-Control-Allow-Headers")]),t._v(" 中，它将发送主请求。")]),t._v(" "),n("p",[t._v("💡 如果服务器将来期望其他方法和 header 可以通过添加到列表中来预先允许它们")]),t._v(" "),n("div",{staticClass:"language-http extra-class"},[n("pre",{pre:!0,attrs:{class:"language-http"}},[n("code",[t._v("200 OK\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Methods:")]),t._v(" PUT,PATCH,DELETE\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Headers:")]),t._v(" API-Key,Content-Type,If-Modified-Since,Cache-Control\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Max-Age:")]),t._v(" 86400\n")])])]),n("p",[t._v("💡 此外预检响应会"),n("strong",[t._v("缓存一段时间")]),t._v("，该时间由 "),n("code",[t._v("Access-Control-Max-Age")]),t._v(" header 指定（86400 秒，一天），因此后续请求将不会导致预检。假设它们符合缓存的配额，则将直接发送它们。")])]),t._v(" "),n("li",[n("p",[t._v("预检成功后，浏览器现在发出主请求，其算法与简单请求的算法相同，主请求具有 "),n("code",[t._v("Origin")]),t._v(" header（因为它是跨源的）")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PATCH")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json\nHost"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com\nContent"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" application"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("json\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("API")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Key"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" secret\nOrigin"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" https"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info\n")])])])]),t._v(" "),n("li",[n("p",[t._v("服务器作出主响应，需要添加 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v("，然后 JavaScript 可以读取主服务器响应了。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("Access"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Control"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Allow"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Origin"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" https"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info\n")])])])])]),t._v(" "),n("h3",{attrs:{id:"凭据"}},[t._v("凭据")]),t._v(" "),n("p",[t._v("默认情况下，跨源请求不会带来任何凭据（cookies 或者 HTTP 认证（HTTP authentication））。")]),t._v(" "),n("p",[t._v("这对于 HTTP 请求来说并不常见。通常，对 "),n("code",[t._v("http://site.com")]),t._v(" 的请求附带有该域的所有 cookie。但是由 JavaScript 方法发出的跨源请求是个例外,如 "),n("code",[t._v("fetch('http://another.com')")]),t._v(" 不会发送任何 cookie，即使那些 (!) 属于 "),n("code",[t._v("another.com")]),t._v(" 域的 cookie。")]),t._v(" "),n("p",[t._v("这是因为具有凭据的请求比没有凭据的请求要强大得多。如果被允许，它会使用它们的凭据授予 JavaScript 代表用户行为和访问敏感信息的全部权力。它必须显式地带有允许请求的凭据和附加 header。要在 "),n("code",[t._v("fetch")]),t._v(" 中发送凭据，我们需要添加 "),n("code",[t._v('credentials: "include"')]),t._v(" 选项，现在，"),n("code",[t._v("fetch")]),t._v(" 将把源自 "),n("code",[t._v("another.com")]),t._v(" 的 cookie 和我们的请求发送到该网站。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://another.com'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  credentials"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"include"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("如果服务器同意接受 "),n("strong",[t._v("带有凭据")]),t._v(" 的请求，则除了 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 外，服务器还应该在响应中添加 header "),n("code",[t._v("Access-Control-Allow-Credentials: true")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language-http extra-class"},[n("pre",{pre:!0,attrs:{class:"language-http"}},[n("code",[t._v("200 OK\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Origin:")]),t._v(" https://javascript.info\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Credentials:")]),t._v(" true\n")])])]),n("p",[t._v("⚠️ 对于具有凭据的请求，禁止 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 使用星号 "),n("code",[t._v("*")]),t._v("。如上所示，它必须有一个确切的源。这是另一项安全措施，以确保服务器真的知道它信任的发出此请求的是谁。")])])}),[],!1,null,null,null);s.default=e.exports}}]);