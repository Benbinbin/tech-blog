---
show: true
collection: D3.js Basic
collectionOrder: 2
cover: D3-basic.png
summary: D3.js 基础概念，介绍选择器、动态属性、enter 和 exit、过渡等。
tags:
  - D3.js
  - data-vis
---

# 基础概念

## 选择器
D3 通过声明式的方法 `d3.select()` 和 `d3.selectAll()` 来选择结点或结点集合，其中传递参数是 CSS 支持的选择器，如类选择器、ID 选择器、属性值选择器等，并通过链式调用的方式操作 DOM（或集合，而不需要使用迭代），D3 提供了大量操作 DOM 结点（集合）的方法，如设置样式属性，更改 HTML 或 文本内容，注册事件监听器，添加、移除、排序结点等。

```js
// 操作单个结点
d3.select("body")
  .style("background-color", "black");

// 也可以操作结点集合
d3.selectAll("p")
  .style("color", "white");

/*--- 等价的原生操作 ---*/
var paragraphs = document.getElementByTagName("p");
for (var i=0; i<paragraphs.length; i++) {
  var paragraph = paragraph.item(i);
  paragraph.style.setProperty("color", "white");
}
```

:bulb: 选择器 `select` 和 `selectAll` 是基于 [W3C Selectors API](https://www.w3.org/TR/selectors-api/) 定义的选择集，支持现代浏览器；如果浏览器比较老旧，则可以借助 [Sizzle](http://sizzlejs.com/) 来向后兼容。

## 动态属性
在 D3 中结点的样式属性的值可以通过函数计算动态设置，而不仅仅是常量，这样 D3 实现各种可视化时变得很强大。D3 还内建了大量可复用的与[图形元素](https://github.com/d3/d3-shape)相关的函数，如面积图、折线图、饼图等。

```js
// 为每个段落设置颜色
d3.selectAll("p").style("color", function() {
  return "hsl(" + Math.random() * 360 + ", 100%, 50%)";
}
```

通过函数计算动态设置的属性通常会与数据进行绑定，数据以数组的形式列出，默认 join-by-index 根据**索引**将 D3 选择的结点（集合）和数组中的元素一一对应（绑定），然后在设置样式属性时，**分别将数组中对应的元素作为第一个参数 `d` 传递到设置函数中**求出特异的值。

```js
// 根据数据值设置不同的字体大小
d3.selectAll("p")
  .data([4, 8, 15, 16, 23, 42])
  .style("font-size", function(d) { return d + "px"; });
```

:bulb: 当 DOM 结点和[数据绑定](https://bost.ocks.org/mike/join/)后，后续如果需要操作 DOM 时（如设置 DOM 属性样式），D3 会再读取先前绑定的数据，即 DOM 一旦绑定了数据就会带有状态，这样就不需要不断地进行数据的映射，直接操作 DOM 时就可以读取它绑定的数据了。

## enter 和 exit
在 D3 中将结点与数据绑定时，选择集合中的结点和数据数组的元素一一匹配，但可能会出现结点和数据元素**个数不匹配**的问题，可以**使用 `enter` 方法为多出的数据新建 DOM 结点或 `exit` 方法将超出（未绑定数据）的结点移除出选择集合**。

如果选择集合中的结点数量比绑定的数组元素个数少，多出的数据元素就会形成 enter selection，可以将这个选择集合 `append` 到页面实例化它们，构建出相应的 DOM 元素。

```js
// 如果文档中原有 <p> 标签的个数少于数组个数（6个），则使用 enter 和 append 操作来补齐 DOM 元素
d3.select("body")
  .selectAll("p")
  .data([4, 8, 15, 16, 23, 42])
  .enter().append("p")
  .text(function(d){ return "I'm number " + d + "!"; });
```

:bulb: 数据绑定到结点时，数据操作的默认行为是更新 update 每个结点的数据，但不会加入新节点或删除多余结点，即只会对已经绑定数据的原有 DOM 结点进行操作，如果需要基于数据增删结点则需要调用方法 `enter` 或 `exit` 对 enter 或 exit 的选择集合进行操作。因此将绑定数据时形成结点集合分为三部分：
* **update 结点集合**是已绑定数据的结点集合，可以直接修改数据；
* **entering 结点集合**对应于新增的数据，待实例化添加到页面上；
* **exiting 结点集合**之前已绑定数据但在新数据集中未有对应数据元素的 DOM 结点，待从页面上删除。

有了这三种操作，就可以自由的根据数据元素动态的修改 DOM 元素了。

```js
// update
let p = d3.select("body")
          .selectAll("p")
          .data([4, 8, 15, 16, 23, 42])
          .text(function(d) { return d; });

// entering
p.enter().append("p")
  .text(function(d) { return d; });

// exiting
p.exit().remove();   //移除多余的元素
```

## 过渡
D3 支持动画效果，这种动画效果是基于样式过渡 `transition` 属性实现的。其补间插值（补间动画）支持多种方式，如线性、弹性等，通过 easing 函数进行设置。此外 D3 除了支持原生的插值方式，如对数值类型、字符类型，还内置了多种插值方式，如复合值。

```js
// 对元素的背景色进行过渡
d3.select("body").transition()
  .style("background-color", "black");

// 在散点图中调整一系列散点大小的动效，设置不同的延迟
d3.selectAll("circle").transition()
  .duration(750)
  .delay(function(d, i) { return i * 10;})   // 基于数据/结点的索引值设置动效的延迟
  .attr("r", function(d) { return Math.sqrt(d * scale});
```

:bulb: 由于 D3 基于 Web 标准来设计，因此除了 D3 提供的过渡之外，也可以对 D3 创建的元素使用通用的 CSS 动画来实现过渡效果。