<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ajax | Tech Blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="Notes written by BenThomson when learning tech skills.">
    
    <link rel="preload" href="/tech-blog/assets/css/0.styles.d6b0b335.css" as="style"><link rel="preload" href="/tech-blog/assets/js/app.e2907910.js" as="script"><link rel="preload" href="/tech-blog/assets/js/19.4fae91a9.js" as="script"><link rel="preload" href="/tech-blog/assets/js/1.c19b0b73.js" as="script"><link rel="preload" href="/tech-blog/assets/js/73.c5de23cd.js" as="script"><link rel="prefetch" href="/tech-blog/assets/js/10.b6368563.js"><link rel="prefetch" href="/tech-blog/assets/js/100.e76d45fb.js"><link rel="prefetch" href="/tech-blog/assets/js/101.4a645a30.js"><link rel="prefetch" href="/tech-blog/assets/js/102.a6b546e7.js"><link rel="prefetch" href="/tech-blog/assets/js/103.b4b72833.js"><link rel="prefetch" href="/tech-blog/assets/js/104.0ebb204e.js"><link rel="prefetch" href="/tech-blog/assets/js/105.b73e77fa.js"><link rel="prefetch" href="/tech-blog/assets/js/106.436e9b33.js"><link rel="prefetch" href="/tech-blog/assets/js/107.fc159900.js"><link rel="prefetch" href="/tech-blog/assets/js/108.df6a446a.js"><link rel="prefetch" href="/tech-blog/assets/js/109.dee6ddc0.js"><link rel="prefetch" href="/tech-blog/assets/js/11.7f313d83.js"><link rel="prefetch" href="/tech-blog/assets/js/110.3ac7e842.js"><link rel="prefetch" href="/tech-blog/assets/js/111.1e260a97.js"><link rel="prefetch" href="/tech-blog/assets/js/112.91a95354.js"><link rel="prefetch" href="/tech-blog/assets/js/113.0260f8a8.js"><link rel="prefetch" href="/tech-blog/assets/js/114.e757a67b.js"><link rel="prefetch" href="/tech-blog/assets/js/115.9266e866.js"><link rel="prefetch" href="/tech-blog/assets/js/116.38cb7f4e.js"><link rel="prefetch" href="/tech-blog/assets/js/117.5c68130b.js"><link rel="prefetch" href="/tech-blog/assets/js/118.e45f0f67.js"><link rel="prefetch" href="/tech-blog/assets/js/119.7c831a81.js"><link rel="prefetch" href="/tech-blog/assets/js/12.50459577.js"><link rel="prefetch" href="/tech-blog/assets/js/120.0b394698.js"><link rel="prefetch" href="/tech-blog/assets/js/121.2f679253.js"><link rel="prefetch" href="/tech-blog/assets/js/122.ca87e3bf.js"><link rel="prefetch" href="/tech-blog/assets/js/123.2c3d9f63.js"><link rel="prefetch" href="/tech-blog/assets/js/124.7af73ab3.js"><link rel="prefetch" href="/tech-blog/assets/js/125.5a8e0f06.js"><link rel="prefetch" href="/tech-blog/assets/js/126.c74b0881.js"><link rel="prefetch" href="/tech-blog/assets/js/127.ca005d5c.js"><link rel="prefetch" href="/tech-blog/assets/js/128.4eb3c0f2.js"><link rel="prefetch" href="/tech-blog/assets/js/129.7d437ef1.js"><link rel="prefetch" href="/tech-blog/assets/js/13.74fe14ff.js"><link rel="prefetch" href="/tech-blog/assets/js/130.ac2c9b29.js"><link rel="prefetch" href="/tech-blog/assets/js/131.b3b8e1f9.js"><link rel="prefetch" href="/tech-blog/assets/js/132.bb174784.js"><link rel="prefetch" href="/tech-blog/assets/js/133.e3f58838.js"><link rel="prefetch" href="/tech-blog/assets/js/134.f7710664.js"><link rel="prefetch" href="/tech-blog/assets/js/135.17e40d08.js"><link rel="prefetch" href="/tech-blog/assets/js/136.7c96c1ac.js"><link rel="prefetch" href="/tech-blog/assets/js/137.06f4bf7f.js"><link rel="prefetch" href="/tech-blog/assets/js/138.51e41cae.js"><link rel="prefetch" href="/tech-blog/assets/js/139.db6de4c6.js"><link rel="prefetch" href="/tech-blog/assets/js/14.b9eb7a74.js"><link rel="prefetch" href="/tech-blog/assets/js/140.7cd18e71.js"><link rel="prefetch" href="/tech-blog/assets/js/141.bb189059.js"><link rel="prefetch" href="/tech-blog/assets/js/142.b3ae92f6.js"><link rel="prefetch" href="/tech-blog/assets/js/143.a84820c0.js"><link rel="prefetch" href="/tech-blog/assets/js/144.71f6dede.js"><link rel="prefetch" href="/tech-blog/assets/js/145.55967075.js"><link rel="prefetch" href="/tech-blog/assets/js/146.afc5f6c4.js"><link rel="prefetch" href="/tech-blog/assets/js/147.bc78c79c.js"><link rel="prefetch" href="/tech-blog/assets/js/148.a2b2a61a.js"><link rel="prefetch" href="/tech-blog/assets/js/149.03267208.js"><link rel="prefetch" href="/tech-blog/assets/js/15.87822948.js"><link rel="prefetch" href="/tech-blog/assets/js/150.930ebe5e.js"><link rel="prefetch" href="/tech-blog/assets/js/151.16885b8e.js"><link rel="prefetch" href="/tech-blog/assets/js/152.1da3b71e.js"><link rel="prefetch" href="/tech-blog/assets/js/153.526ebd90.js"><link rel="prefetch" href="/tech-blog/assets/js/154.59aff75a.js"><link rel="prefetch" href="/tech-blog/assets/js/155.b6348b0c.js"><link rel="prefetch" href="/tech-blog/assets/js/156.9b730b36.js"><link rel="prefetch" href="/tech-blog/assets/js/157.714e8356.js"><link rel="prefetch" href="/tech-blog/assets/js/158.ed339647.js"><link rel="prefetch" href="/tech-blog/assets/js/159.bb53475e.js"><link rel="prefetch" href="/tech-blog/assets/js/16.ed1157a5.js"><link rel="prefetch" href="/tech-blog/assets/js/160.7c7d0c92.js"><link rel="prefetch" href="/tech-blog/assets/js/161.860b8f7c.js"><link rel="prefetch" href="/tech-blog/assets/js/162.11bf5a07.js"><link rel="prefetch" href="/tech-blog/assets/js/163.76dfbd4a.js"><link rel="prefetch" href="/tech-blog/assets/js/164.998d552b.js"><link rel="prefetch" href="/tech-blog/assets/js/165.4b7fea67.js"><link rel="prefetch" href="/tech-blog/assets/js/166.5bd52768.js"><link rel="prefetch" href="/tech-blog/assets/js/167.d966178f.js"><link rel="prefetch" href="/tech-blog/assets/js/168.220219c5.js"><link rel="prefetch" href="/tech-blog/assets/js/169.7c0f662b.js"><link rel="prefetch" href="/tech-blog/assets/js/17.fb473c93.js"><link rel="prefetch" href="/tech-blog/assets/js/170.c687f331.js"><link rel="prefetch" href="/tech-blog/assets/js/171.84c9eb16.js"><link rel="prefetch" href="/tech-blog/assets/js/172.1057763b.js"><link rel="prefetch" href="/tech-blog/assets/js/173.863408c4.js"><link rel="prefetch" href="/tech-blog/assets/js/174.ae976955.js"><link rel="prefetch" href="/tech-blog/assets/js/175.723d8fb3.js"><link rel="prefetch" href="/tech-blog/assets/js/176.4e52e151.js"><link rel="prefetch" href="/tech-blog/assets/js/177.28e3dbd9.js"><link rel="prefetch" href="/tech-blog/assets/js/178.fe642e1b.js"><link rel="prefetch" href="/tech-blog/assets/js/179.8a237636.js"><link rel="prefetch" href="/tech-blog/assets/js/18.8d825957.js"><link rel="prefetch" href="/tech-blog/assets/js/180.7d5bab8b.js"><link rel="prefetch" href="/tech-blog/assets/js/181.2b1b15fd.js"><link rel="prefetch" href="/tech-blog/assets/js/182.049370ee.js"><link rel="prefetch" href="/tech-blog/assets/js/183.06ccd661.js"><link rel="prefetch" href="/tech-blog/assets/js/184.0af82719.js"><link rel="prefetch" href="/tech-blog/assets/js/185.d261b0af.js"><link rel="prefetch" href="/tech-blog/assets/js/186.2454c831.js"><link rel="prefetch" href="/tech-blog/assets/js/187.c6e8c2fb.js"><link rel="prefetch" href="/tech-blog/assets/js/188.98775ab9.js"><link rel="prefetch" href="/tech-blog/assets/js/189.32aae8d7.js"><link rel="prefetch" href="/tech-blog/assets/js/190.f4621a4d.js"><link rel="prefetch" href="/tech-blog/assets/js/191.9466b89e.js"><link rel="prefetch" href="/tech-blog/assets/js/192.51af6405.js"><link rel="prefetch" href="/tech-blog/assets/js/193.adcb809e.js"><link rel="prefetch" href="/tech-blog/assets/js/194.c96d7977.js"><link rel="prefetch" href="/tech-blog/assets/js/195.3e20a5ff.js"><link rel="prefetch" href="/tech-blog/assets/js/196.538eca67.js"><link rel="prefetch" href="/tech-blog/assets/js/197.64c0b608.js"><link rel="prefetch" href="/tech-blog/assets/js/198.a9a0b850.js"><link rel="prefetch" href="/tech-blog/assets/js/199.f0f16c6c.js"><link rel="prefetch" href="/tech-blog/assets/js/2.566c27d6.js"><link rel="prefetch" href="/tech-blog/assets/js/20.d74b39d9.js"><link rel="prefetch" href="/tech-blog/assets/js/200.c84b6726.js"><link rel="prefetch" href="/tech-blog/assets/js/201.fab1ff25.js"><link rel="prefetch" href="/tech-blog/assets/js/202.232d9fa7.js"><link rel="prefetch" href="/tech-blog/assets/js/203.305c86b7.js"><link rel="prefetch" href="/tech-blog/assets/js/204.949c7add.js"><link rel="prefetch" href="/tech-blog/assets/js/205.184b0b2d.js"><link rel="prefetch" href="/tech-blog/assets/js/206.3fd3cfa2.js"><link rel="prefetch" href="/tech-blog/assets/js/207.9e6b9521.js"><link rel="prefetch" href="/tech-blog/assets/js/208.ecbcc4da.js"><link rel="prefetch" href="/tech-blog/assets/js/209.ee7faba1.js"><link rel="prefetch" href="/tech-blog/assets/js/21.0185f12c.js"><link rel="prefetch" href="/tech-blog/assets/js/210.b5d484ac.js"><link rel="prefetch" href="/tech-blog/assets/js/211.e8092c05.js"><link rel="prefetch" href="/tech-blog/assets/js/212.0e6ba584.js"><link rel="prefetch" href="/tech-blog/assets/js/213.ff3d4871.js"><link rel="prefetch" href="/tech-blog/assets/js/214.5bae2dc0.js"><link rel="prefetch" href="/tech-blog/assets/js/215.62695694.js"><link rel="prefetch" href="/tech-blog/assets/js/216.d657080f.js"><link rel="prefetch" href="/tech-blog/assets/js/217.ce6cde02.js"><link rel="prefetch" href="/tech-blog/assets/js/218.865fd3cf.js"><link rel="prefetch" href="/tech-blog/assets/js/219.6571a742.js"><link rel="prefetch" href="/tech-blog/assets/js/22.2d412bec.js"><link rel="prefetch" href="/tech-blog/assets/js/220.18e726d8.js"><link rel="prefetch" href="/tech-blog/assets/js/221.c9db8555.js"><link rel="prefetch" href="/tech-blog/assets/js/222.7b19269a.js"><link rel="prefetch" href="/tech-blog/assets/js/223.f1a5cd82.js"><link rel="prefetch" href="/tech-blog/assets/js/224.124126e0.js"><link rel="prefetch" href="/tech-blog/assets/js/225.44034b61.js"><link rel="prefetch" href="/tech-blog/assets/js/226.4fe77bfd.js"><link rel="prefetch" href="/tech-blog/assets/js/227.f96362d4.js"><link rel="prefetch" href="/tech-blog/assets/js/228.a02346a8.js"><link rel="prefetch" href="/tech-blog/assets/js/229.3cf5a688.js"><link rel="prefetch" href="/tech-blog/assets/js/23.9d37722d.js"><link rel="prefetch" href="/tech-blog/assets/js/230.7fb68917.js"><link rel="prefetch" href="/tech-blog/assets/js/231.303d5843.js"><link rel="prefetch" href="/tech-blog/assets/js/232.9487eead.js"><link rel="prefetch" href="/tech-blog/assets/js/233.c40e35a8.js"><link rel="prefetch" href="/tech-blog/assets/js/234.c2e08d41.js"><link rel="prefetch" href="/tech-blog/assets/js/235.13434890.js"><link rel="prefetch" href="/tech-blog/assets/js/236.58235d4b.js"><link rel="prefetch" href="/tech-blog/assets/js/237.74ec86f6.js"><link rel="prefetch" href="/tech-blog/assets/js/238.a2cecdbf.js"><link rel="prefetch" href="/tech-blog/assets/js/239.31cb5750.js"><link rel="prefetch" href="/tech-blog/assets/js/24.bd0ece1f.js"><link rel="prefetch" href="/tech-blog/assets/js/240.0d0ecd96.js"><link rel="prefetch" href="/tech-blog/assets/js/241.a56701a5.js"><link rel="prefetch" href="/tech-blog/assets/js/242.8c0043d9.js"><link rel="prefetch" href="/tech-blog/assets/js/243.352cbd64.js"><link rel="prefetch" href="/tech-blog/assets/js/244.3a8b742d.js"><link rel="prefetch" href="/tech-blog/assets/js/245.d195e8c4.js"><link rel="prefetch" href="/tech-blog/assets/js/246.72ef9e6d.js"><link rel="prefetch" href="/tech-blog/assets/js/247.c60e70ff.js"><link rel="prefetch" href="/tech-blog/assets/js/248.190b2e01.js"><link rel="prefetch" href="/tech-blog/assets/js/249.44f039a3.js"><link rel="prefetch" href="/tech-blog/assets/js/25.b3e6892d.js"><link rel="prefetch" href="/tech-blog/assets/js/250.d4f68fc6.js"><link rel="prefetch" href="/tech-blog/assets/js/251.c54bd24f.js"><link rel="prefetch" href="/tech-blog/assets/js/252.ef86b8ae.js"><link rel="prefetch" href="/tech-blog/assets/js/253.af575fd6.js"><link rel="prefetch" href="/tech-blog/assets/js/254.8684b1e9.js"><link rel="prefetch" href="/tech-blog/assets/js/255.da5fba2d.js"><link rel="prefetch" href="/tech-blog/assets/js/256.cdd1dbb6.js"><link rel="prefetch" href="/tech-blog/assets/js/257.cecc66ec.js"><link rel="prefetch" href="/tech-blog/assets/js/258.fcf3c1b2.js"><link rel="prefetch" href="/tech-blog/assets/js/259.dd0b785d.js"><link rel="prefetch" href="/tech-blog/assets/js/26.c667f021.js"><link rel="prefetch" href="/tech-blog/assets/js/260.6941e2e1.js"><link rel="prefetch" href="/tech-blog/assets/js/261.fa9b1454.js"><link rel="prefetch" href="/tech-blog/assets/js/262.cf8f5b55.js"><link rel="prefetch" href="/tech-blog/assets/js/263.fa67afc2.js"><link rel="prefetch" href="/tech-blog/assets/js/264.6b2dbe26.js"><link rel="prefetch" href="/tech-blog/assets/js/265.d7c5b8fd.js"><link rel="prefetch" href="/tech-blog/assets/js/266.1a162200.js"><link rel="prefetch" href="/tech-blog/assets/js/267.1b5df710.js"><link rel="prefetch" href="/tech-blog/assets/js/268.c2294c76.js"><link rel="prefetch" href="/tech-blog/assets/js/269.6abb34d3.js"><link rel="prefetch" href="/tech-blog/assets/js/27.605f1183.js"><link rel="prefetch" href="/tech-blog/assets/js/270.2cc387ea.js"><link rel="prefetch" href="/tech-blog/assets/js/271.4c0a8152.js"><link rel="prefetch" href="/tech-blog/assets/js/272.76579b08.js"><link rel="prefetch" href="/tech-blog/assets/js/273.a8e5e247.js"><link rel="prefetch" href="/tech-blog/assets/js/274.b0283f29.js"><link rel="prefetch" href="/tech-blog/assets/js/275.c82e7c90.js"><link rel="prefetch" href="/tech-blog/assets/js/276.50485337.js"><link rel="prefetch" href="/tech-blog/assets/js/277.7954540b.js"><link rel="prefetch" href="/tech-blog/assets/js/278.8ffafc74.js"><link rel="prefetch" href="/tech-blog/assets/js/279.b5a8028b.js"><link rel="prefetch" href="/tech-blog/assets/js/28.cea010b7.js"><link rel="prefetch" href="/tech-blog/assets/js/280.e972cc66.js"><link rel="prefetch" href="/tech-blog/assets/js/281.d0a4a70f.js"><link rel="prefetch" href="/tech-blog/assets/js/282.0f7e5b86.js"><link rel="prefetch" href="/tech-blog/assets/js/283.4cd3db83.js"><link rel="prefetch" href="/tech-blog/assets/js/284.da3d7e42.js"><link rel="prefetch" href="/tech-blog/assets/js/285.2ead31b6.js"><link rel="prefetch" href="/tech-blog/assets/js/286.d1e75872.js"><link rel="prefetch" href="/tech-blog/assets/js/287.7bdbbd2c.js"><link rel="prefetch" href="/tech-blog/assets/js/288.f1bb48ac.js"><link rel="prefetch" href="/tech-blog/assets/js/289.5cb43d47.js"><link rel="prefetch" href="/tech-blog/assets/js/29.7f84a6c7.js"><link rel="prefetch" href="/tech-blog/assets/js/290.17d46c7f.js"><link rel="prefetch" href="/tech-blog/assets/js/291.d856f05f.js"><link rel="prefetch" href="/tech-blog/assets/js/292.f353b737.js"><link rel="prefetch" href="/tech-blog/assets/js/293.3219d668.js"><link rel="prefetch" href="/tech-blog/assets/js/294.da30deed.js"><link rel="prefetch" href="/tech-blog/assets/js/295.3ef190bc.js"><link rel="prefetch" href="/tech-blog/assets/js/296.51842e35.js"><link rel="prefetch" href="/tech-blog/assets/js/297.d5d8bc7c.js"><link rel="prefetch" href="/tech-blog/assets/js/298.c4d02eb3.js"><link rel="prefetch" href="/tech-blog/assets/js/299.34fbb12f.js"><link rel="prefetch" href="/tech-blog/assets/js/30.a690c277.js"><link rel="prefetch" href="/tech-blog/assets/js/300.dc4ebe83.js"><link rel="prefetch" href="/tech-blog/assets/js/301.3d79013b.js"><link rel="prefetch" href="/tech-blog/assets/js/302.b7bc2077.js"><link rel="prefetch" href="/tech-blog/assets/js/303.f507bd62.js"><link rel="prefetch" href="/tech-blog/assets/js/304.70c76de8.js"><link rel="prefetch" href="/tech-blog/assets/js/305.06c79abd.js"><link rel="prefetch" href="/tech-blog/assets/js/306.b51ab104.js"><link rel="prefetch" href="/tech-blog/assets/js/307.18923549.js"><link rel="prefetch" href="/tech-blog/assets/js/308.a49a1d4b.js"><link rel="prefetch" href="/tech-blog/assets/js/309.400f0e43.js"><link rel="prefetch" href="/tech-blog/assets/js/31.210edda6.js"><link rel="prefetch" href="/tech-blog/assets/js/310.a706d0e5.js"><link rel="prefetch" href="/tech-blog/assets/js/311.7d82a7d9.js"><link rel="prefetch" href="/tech-blog/assets/js/312.58bba4e3.js"><link rel="prefetch" href="/tech-blog/assets/js/313.6147c60c.js"><link rel="prefetch" href="/tech-blog/assets/js/314.9c828d81.js"><link rel="prefetch" href="/tech-blog/assets/js/315.b71aca4e.js"><link rel="prefetch" href="/tech-blog/assets/js/316.dedf13de.js"><link rel="prefetch" href="/tech-blog/assets/js/317.1c6aedeb.js"><link rel="prefetch" href="/tech-blog/assets/js/318.4d069328.js"><link rel="prefetch" href="/tech-blog/assets/js/319.ead84e89.js"><link rel="prefetch" href="/tech-blog/assets/js/32.4f0968eb.js"><link rel="prefetch" href="/tech-blog/assets/js/320.9196af73.js"><link rel="prefetch" href="/tech-blog/assets/js/321.1be13b10.js"><link rel="prefetch" href="/tech-blog/assets/js/322.6fa37b4f.js"><link rel="prefetch" href="/tech-blog/assets/js/323.f9d29aaf.js"><link rel="prefetch" href="/tech-blog/assets/js/324.cb6a6903.js"><link rel="prefetch" href="/tech-blog/assets/js/325.264b4bab.js"><link rel="prefetch" href="/tech-blog/assets/js/326.cd71f7a2.js"><link rel="prefetch" href="/tech-blog/assets/js/327.799dc92d.js"><link rel="prefetch" href="/tech-blog/assets/js/328.0f17409b.js"><link rel="prefetch" href="/tech-blog/assets/js/329.96099252.js"><link rel="prefetch" href="/tech-blog/assets/js/33.87770ad1.js"><link rel="prefetch" href="/tech-blog/assets/js/330.0bcb80da.js"><link rel="prefetch" href="/tech-blog/assets/js/331.946fd31f.js"><link rel="prefetch" href="/tech-blog/assets/js/332.60beb333.js"><link rel="prefetch" href="/tech-blog/assets/js/34.8ee59d40.js"><link rel="prefetch" href="/tech-blog/assets/js/35.fd994a34.js"><link rel="prefetch" href="/tech-blog/assets/js/36.584bf91b.js"><link rel="prefetch" href="/tech-blog/assets/js/37.270d1bd2.js"><link rel="prefetch" href="/tech-blog/assets/js/38.30bcfdaf.js"><link rel="prefetch" href="/tech-blog/assets/js/39.89d52ebd.js"><link rel="prefetch" href="/tech-blog/assets/js/4.6cf2314e.js"><link rel="prefetch" href="/tech-blog/assets/js/40.b8b49036.js"><link rel="prefetch" href="/tech-blog/assets/js/41.4b138d38.js"><link rel="prefetch" href="/tech-blog/assets/js/42.2b0134be.js"><link rel="prefetch" href="/tech-blog/assets/js/43.e60d3b0a.js"><link rel="prefetch" href="/tech-blog/assets/js/44.520ae30e.js"><link rel="prefetch" href="/tech-blog/assets/js/45.61a6fdb6.js"><link rel="prefetch" href="/tech-blog/assets/js/46.32a9d5f4.js"><link rel="prefetch" href="/tech-blog/assets/js/47.ccfe5207.js"><link rel="prefetch" href="/tech-blog/assets/js/48.beb20f17.js"><link rel="prefetch" href="/tech-blog/assets/js/49.eacc8bb4.js"><link rel="prefetch" href="/tech-blog/assets/js/5.a85c6e29.js"><link rel="prefetch" href="/tech-blog/assets/js/50.1643ee2a.js"><link rel="prefetch" href="/tech-blog/assets/js/51.03d8de2e.js"><link rel="prefetch" href="/tech-blog/assets/js/52.9bc355c6.js"><link rel="prefetch" href="/tech-blog/assets/js/53.53fb7223.js"><link rel="prefetch" href="/tech-blog/assets/js/54.6431de40.js"><link rel="prefetch" href="/tech-blog/assets/js/55.799b4392.js"><link rel="prefetch" href="/tech-blog/assets/js/56.1cd36345.js"><link rel="prefetch" href="/tech-blog/assets/js/57.a8fb9be3.js"><link rel="prefetch" href="/tech-blog/assets/js/58.4d7b06af.js"><link rel="prefetch" href="/tech-blog/assets/js/59.29bf2f4d.js"><link rel="prefetch" href="/tech-blog/assets/js/6.71a576b7.js"><link rel="prefetch" href="/tech-blog/assets/js/60.67eaec2f.js"><link rel="prefetch" href="/tech-blog/assets/js/61.de748b43.js"><link rel="prefetch" href="/tech-blog/assets/js/62.a49d9fca.js"><link rel="prefetch" href="/tech-blog/assets/js/63.5e3465c8.js"><link rel="prefetch" href="/tech-blog/assets/js/64.5dde0633.js"><link rel="prefetch" href="/tech-blog/assets/js/65.961dc970.js"><link rel="prefetch" href="/tech-blog/assets/js/66.61692b0a.js"><link rel="prefetch" href="/tech-blog/assets/js/67.6daf46ab.js"><link rel="prefetch" href="/tech-blog/assets/js/68.a48ed68c.js"><link rel="prefetch" href="/tech-blog/assets/js/69.88422d5f.js"><link rel="prefetch" href="/tech-blog/assets/js/7.d11dade5.js"><link rel="prefetch" href="/tech-blog/assets/js/70.374bef78.js"><link rel="prefetch" href="/tech-blog/assets/js/71.f190667d.js"><link rel="prefetch" href="/tech-blog/assets/js/72.2e1c337a.js"><link rel="prefetch" href="/tech-blog/assets/js/74.6dcf0a86.js"><link rel="prefetch" href="/tech-blog/assets/js/75.bc364138.js"><link rel="prefetch" href="/tech-blog/assets/js/76.7311fb56.js"><link rel="prefetch" href="/tech-blog/assets/js/77.028b8105.js"><link rel="prefetch" href="/tech-blog/assets/js/78.a6e8f401.js"><link rel="prefetch" href="/tech-blog/assets/js/79.df7a0e94.js"><link rel="prefetch" href="/tech-blog/assets/js/8.22a8a907.js"><link rel="prefetch" href="/tech-blog/assets/js/80.e8f9a567.js"><link rel="prefetch" href="/tech-blog/assets/js/81.8fb708c0.js"><link rel="prefetch" href="/tech-blog/assets/js/82.48f868f9.js"><link rel="prefetch" href="/tech-blog/assets/js/83.0b358ab1.js"><link rel="prefetch" href="/tech-blog/assets/js/84.e443ac1b.js"><link rel="prefetch" href="/tech-blog/assets/js/85.011fafc0.js"><link rel="prefetch" href="/tech-blog/assets/js/86.f27210ae.js"><link rel="prefetch" href="/tech-blog/assets/js/87.405c7161.js"><link rel="prefetch" href="/tech-blog/assets/js/88.db7bac07.js"><link rel="prefetch" href="/tech-blog/assets/js/89.370dba33.js"><link rel="prefetch" href="/tech-blog/assets/js/9.0a76bf22.js"><link rel="prefetch" href="/tech-blog/assets/js/90.25e4d526.js"><link rel="prefetch" href="/tech-blog/assets/js/91.29b56c3f.js"><link rel="prefetch" href="/tech-blog/assets/js/92.55379378.js"><link rel="prefetch" href="/tech-blog/assets/js/93.767d64b6.js"><link rel="prefetch" href="/tech-blog/assets/js/94.48e135ed.js"><link rel="prefetch" href="/tech-blog/assets/js/95.8cec0d9a.js"><link rel="prefetch" href="/tech-blog/assets/js/96.b67923fb.js"><link rel="prefetch" href="/tech-blog/assets/js/97.59681e1a.js"><link rel="prefetch" href="/tech-blog/assets/js/98.b26adaa8.js"><link rel="prefetch" href="/tech-blog/assets/js/99.f867f3cb.js">
    <link rel="stylesheet" href="/tech-blog/assets/css/0.styles.d6b0b335.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="min-h-screen flex flex-col"><div class="relative flex-grow"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tech-blog/" class="home-link router-link-active"><!----> <span class="site-name">Tech Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tech-blog/posts-list/index.html" class="nav-link">
  All
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/data.html" class="nav-link">
  Data
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/web.html" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/design.html" class="nav-link">
  Design
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/other.html" class="nav-link">
  Other
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tech-blog/posts-list/index.html" class="nav-link">
  All
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/data.html" class="nav-link">
  Data
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/web.html" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/design.html" class="nav-link">
  Design
</a></div><div class="nav-item"><a href="/tech-blog/posts-list/other.html" class="nav-link">
  Other
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ajax">Ajax</h1> <p>参考：<a href="http://codemany.com/blog/ajax-new-approach-web-applications/" target="_blank" rel="noopener noreferrer">Ajax：Web应用的一种新方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Ajax，Asynchronous JavaScript And XML，即异步的 JavaScript 与 XML 技术，该概念是在 2005 年 <a href="https://web.archive.org/web/20080702075113/http://www.adaptivepath.com/ideas/essays/archives/000385.php" target="_blank" rel="noopener noreferrer">Jesse James Garrett 发明的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>该技术核心概念是异步请求数据，即在客户端发出数据请求后，不需要等待请求返回，借助 Ajax引擎可以继续进行其他任务处理，待请求返回后再进行异步处理，该过程不用一次次重新加载整个页面，而只需要根据响应更新特定区域的数据。</p> <p>Ajax 技术包括：</p> <ul><li>使用 XHTML 和 CSS 的 <a href="http://adaptivepath.org/publications/essays/archives/000266.php" target="_blank" rel="noopener noreferrer">standards-based presentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>使用 <a href="http://www.scottandrew.com/weblog/articles/dom_1" target="_blank" rel="noopener noreferrer">Document Object Model<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的动态显示和交互；</li> <li>使用 <a href="http://www-106.ibm.com/developerworks/xml/library/x-xslt/?article=xr" target="_blank" rel="noopener noreferrer">XML 和 XSLT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的数据交换和操控；</li> <li>使用 <a href="http://www.xml.com/pub/a/2005/02/09/xml-http-request.html" target="_blank" rel="noopener noreferrer">XMLHttpRequest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的异步数据检索；</li> <li><a href="http://www.crockford.com/javascript/javascript.html" target="_blank" rel="noopener noreferrer">JavaScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 将所有这些绑定在一起。</li></ul> <p><img src="/tech-blog/assets/img/20200126121303548_29356.25164e83.png" alt="Ajax 与传统的数据请求模型对比"></p> <p>其中 Ajax 技术核心是发送异步数据请求，可以通过多种方式实现：</p> <ul><li>使用 JavaScript 内置的 XMLHttpRequest 构造函数（创建 XMLHttpRequest/XHR 对象）生成异步请求</li> <li>使用 jQuery 生成异步请求</li> <li>使用 fetch API 生成异步请求</li></ul> <h2 id="xmlhttprequest">XMLHttpRequest</h2> <p>参考：</p> <ul><li><a href="https://zh.javascript.info/xmlhttprequest" target="_blank" rel="noopener noreferrer">XMLHttpRequest | 现代 JavaScript 教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest" target="_blank" rel="noopener noreferrer">使用 XMLHttpRequest - Web API 接口参考 | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://xhr.spec.whatwg.org/" target="_blank" rel="noopener noreferrer">XMLHttpRequest Standard | WHATWG 规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.w3.org/TR/XMLHttpRequest/" target="_blank" rel="noopener noreferrer">XMLHttpRequest Level 1 | W3C 规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.html5rocks.com/zh/tutorials/file/xhr2/" target="_blank" rel="noopener noreferrer">XMLHttpRequest2 新技巧<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> | <a href="https://www.html5rocks.com/en/tutorials/file/xhr2/" target="_blank" rel="noopener noreferrer">英文<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>XMLHttpRequest（缩写为 XHR 或 xhr）可以用来向 API 请求任何类型的文件（例如 <code>txt</code> 纯文本文件、<code>HTML</code> 文件、<code>JSON</code> 文件、图片文件等）或数据，而不仅仅是XML，它甚至支持 HTTP 以外的协议（包括 file:// 和 FTP）。</p> <p>⚠️ 如今有一个更为现代的方法 <code>fetch</code> 发送异步网络请求，它的出现使得 <code>XMLHttpRequest</code> 在某种程度上被弃用。在现代 Web 开发中，出于以下三种原因，我们还在使用 <code>XMLHttpRequest</code>：</p> <ol><li>历史原因：我们需要支持现有的使用了 <code>XMLHttpRequest</code> 的脚本。</li> <li>我们需要兼容旧浏览器，并且不想用 polyfill。</li> <li>我们需要做一些 <code>fetch</code> 目前无法做到的事情，如<strong>跟踪上传进度</strong>。</li></ol> <p>JavaScript 引擎提供了发出异步 HTTP 请求的方式，调用其内置的 <strong>XMLHttpRequest 构造函数</strong>创建 XHR 对象，以创建 Ajax 请求。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/my/url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// HTTP error?</span>
    <span class="token comment">// 处理 error</span>
    <span class="token function">alert</span><span class="token punctuation">(</span> <span class="token string">'Error: '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取来自 xhr.response 的响应</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 报告下载进度</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Loaded </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理非 HTTP error（如网络中断）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>XMLHttpRequest 发送网络请求步骤：</p> <ul><li><p>XMLHttpRequest 有两种执行模式，同步 synchronous 和异步 asynchronous，异步模式发送请求需要 3 个步骤：</p> <ol><li><p>使用 <code>XMLHttpRequest</code> 构造函数创建 XHR 对象</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构造函数没有参数</span>
</code></pre></div></li> <li><p>使用 <code>open()</code> 方法初始化 XHR 对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 调用 .open 方法时并不会建立连接，仅仅设置当前请求的配置</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>async<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>在创建 XHR 对象之后，通常调用 <code>.open()</code> 函数指定了请求的主要参数：</p> <ul><li><code>method</code> 指代 HTTP 方法。通常是 <code>GET</code> 或者 <code>POST</code></li> <li><code>URL</code> 指定要执行请求的 URL 字符串，或可以 URL 对象。</li> <li><code>async</code> 如果设置为 <code>false</code> 请求将会以同步的方式处理（默认为 <code>true</code> 即异步执行）</li> <li><code>user</code> 和 <code>password</code> 指定 HTTP 基本身份认证（可选）的登录名和密码</li></ul> <p>💡 使用 <code>xhr</code> 对象属性 <code>timeout</code> 设置超时限制，如果在给定时间内请求没有成功执行就会被取消，并且<strong>触发 <code>timeout</code> 事件</strong>。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> <span class="token comment">// timeout 单位是 ms，此处即 10 秒</span>
</code></pre></div></li> <li><p>使用方法 <code>send()</code> 发送请求</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 建立连接，并发送请求到服务器</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span>body<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>可选参数 body 包含了请求主体 :</p> <ul><li><code>GET</code> 没有请求体</li> <li><code>POST</code> 这类请求方式会用 <code>body</code> 来发送数据到服务器</li></ul></li></ol></li> <li><p>然后就是监听响应事件，设置对成功/错误的响应的处理程序（⚠️ 需要<strong>在发出请求前</strong>完成监听响应事件的设置）。常见的三个事件：</p> <ul><li>事件 <code>load</code> 在请求结果已经返回时触发，⚠️ 请求返回也包括像 <code>404</code> 这样的 HTTP 错误。通过 XHR 对象属性 <code>onload</code> 监听成功返回的事件，并设置相应的处理程序</li> <li>事件 <code>error</code> 在无法完成请求时触发，比如网络中断或者无效的 URL。通过 XHR 对象属性 <code>onerroe</code> 监听错误响应的事件，并设置无法实现请求的处理程序</li> <li>事件 <code>progress</code> 在下载期间定时触发，报告已经下载了多少。通过 XHR 对象属性 <code>onprogress</code> 来设置下载响应过程中执行的操作</li></ul></li> <li><p>最后如果请求成功，并获得响应消息，就需要对返回的响应体 <code>xhr.response</code> 作进一步分析。</p></li></ul> <h3 id="open-方法">open() 方法</h3> <p>XHR 对象使用方法 <code>.open(method, URL)</code> 设置请求配置，有多个参数但是最重要的参数是前两个参数：</p> <ol><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP" target="_blank" rel="noopener noreferrer">HTTP 方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，主要是两种 <code>GET</code>检索数据或 <code>POST</code> 发送数据</li> <li>要发送请求的 URL</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 向图片网站 Unsplash 发出首页异步请求，使用 GET 请求并提供相关 URL</span>
asyncRequestObject<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'https://unsplash.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>💡 可将 <code>false</code> 作为第三个参数使 XHR 请求变成<strong>同步请求</strong>。这将导致 JavaScript 引擎在执行 <code>send()</code> 后暂停并等待返回该请求，称为「阻止」，然后再继续。这做法完全与异步行为的目的相违背，同步请求会阻塞页面内的其他脚本执行，如果一个同步调用执行时间过长浏览器可能会建议关闭「挂起」hanging 的网页。⚠️ 请勿如此设置你的 XHR 对象！要么将第三个参数设为 <code>true</code> 或留空（默认值变成 <code>true</code>）。</p> <p>⚠️ 该方法并没有实际地发送请求！它的作用只是做好准备，向 XHR 对象提供请求所需的信息。</p> <p>⚠️ 一般只能在将加载数据的<strong>同一网域中</strong>发出资源和数据请求，如要向 google.com 发出异步数据请求，浏览器需要位于 <code>google.com</code> 上，这称为 <a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">同源策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这一限制是出于安全考虑，原因是 JavaScript 对网页上的太多信息具有控制权，它可以访问所有的 Cookie、能够判断密码（因为它可以追踪用户按的是哪个键）等。解决同源策略限制的方式是使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener noreferrer">CORS, Cross-Origin Resource Sharing 跨域请求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，这是必须在服务器上实现的技术，能让开发者规避同源策略限制并访问这些服务器上的信息。</p> <h4 id="post">POST</h4> <p>当我们需要发送大量数据时，如表单等，需要使用 <code>POST</code> 方法。</p> <p>💡 如果需要处理表单数据，可以<a href="#FormData">使用构造函数 <code>FormData([form])</code> 创建一个 HTML 表单数据对象</a>，可以使用该对象提供的许多便捷方法。当以 FormData 对象作为 request body 时，即 <code>xhr.send(formData)</code>，则请求表头会含有  <code>Content-Type: multipart/form-data</code> 的 header。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>person<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>John<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>surname<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Smith<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// 从表单预填充 FormData</span>
  <span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>forms<span class="token punctuation">.</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 附加一个字段</span>
  formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;middle&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Lee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将其发送出去</span>
  <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/article/xmlhttprequest/post/user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 使用 POST 方法</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="http-header">HTTP-header</h3> <p>HTTP-header 是客户端和服务器通讯时头部信息，对象 <code>xhr</code> 有三种方法设置/读取自定义的 header，以发送附加的信息。</p> <p>⚠️ <a href="http://www.w3.org/TR/XMLHttpRequest/#the-setrequestheader-method" target="_blank" rel="noopener noreferrer">一些 header 是由浏览器专门管理设置的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，如 <code>Referer</code> 和 <code>Host</code>，为了用户安全和请求的正确性不允通过对象 <code>xhr</code> 的方法更改它们。</p> <ul><li><p>方法 <code>xhr.setRequestHeader(name, value)</code> 使用给定的 <code>name</code> 和 <code>value</code> 设置 request header，必须在 <code>open()</code> 之后、<code>send()</code> 之前调用该方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>⚠️ <code>XMLHttpRequest</code> 的一个特点是<strong>不能撤销 <code>setRequestHeader</code></strong>，即一旦设置了 header 就无法撤销了，其他调用会向 header 中添加信息，但不会覆盖它。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Auth'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Auth'</span><span class="token punctuation">,</span> <span class="token string">'456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// header 将是：</span>
<span class="token comment">// X-Auth: 123, 456</span>
</code></pre></div></li> <li><p>方法 <code>getResponseHeader(name)</code> 获取响应头中给定 <code>name</code> 的 header（<code>Set-Cookie</code> 和 <code>Set-Cookie2</code> 除外）。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>方法 <code>getAllResponseHeaders()</code> 返回除 <code>Set-Cookie</code> 和 <code>Set-Cookie2</code> 外响应头中所有 response header。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// header 以单行形式返回</span>
Cache<span class="token operator">-</span>Control<span class="token operator">:</span> max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">31536000</span>
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">4260</span>
Content<span class="token operator">-</span>Type<span class="token operator">:</span> image<span class="token operator">/</span>png
Date<span class="token operator">:</span> Sat<span class="token punctuation">,</span> <span class="token number">08</span> Sep <span class="token number">2012</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">16</span> <span class="token constant">GMT</span>
</code></pre></div><p>它们之间的换行符始终为 <code>&quot;\r\n&quot;</code>（不依赖于操作系统），而且<code>name</code> 和 <code>value</code> 之间总是以冒号后跟一个空格 <code>&quot;: &quot;</code> 分隔，基于这些标准格式可以很容易将它们拆分为单个 header。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将所有的 header 拆分为对象 result 的各个属性</span>
<span class="token keyword">let</span> headers <span class="token operator">=</span> xhr
  <span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\r\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// headers['Content-Type'] = 'image/png'</span>
</code></pre></div></li></ul> <h3 id="send-方法">send() 方法</h3> <p>要实际地发送请求，需要调用 XHR <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/send" target="_blank" rel="noopener noreferrer">方法 <code>.send()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
![发送 Ajax 请求](./_v_images/20200126161625614_20161.png =1000x)</p> <p>虽然请求发出了，但如果不对响应事件作出监视，则请求成功或失败在都没有任何提示。为了监视事件可以设置 XHR 对象的 <code>onload</code> 属性或 <code>onerror</code> 属性。</p> <h4 id="上传进度">上传进度</h4> <p>事件 <code>progress</code> 仅在下载阶段触发，可以通过监听该事件追踪下载过程。而对于上传过程可以监听 <code>xhr.upload</code> 对象，上传过程中会在其上触发不同事件，通过监听这些事件可以追踪上传过程</p> <ul><li>事件 <code>loadstart</code> 在上传开始时触发</li> <li>事件 <code>progress</code> <strong>在上传期间定期触发</strong></li> <li>事件 <code>abort</code> 在上传中止触发</li> <li>事件 <code>error</code> 在非 HTTP 错误抛出时触发</li> <li>事件 <code>load</code> 在上传成功完成时触发</li> <li>事件 <code>timeout</code> （如果设置了 <code>timeout</code> 属性）在上传超时时触发。</li> <li>事件 <code>loadend</code> 在上传完成时触发，无论成功还是 error。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// event.loaded 表示已上传字节数，event.total 表示总字节数</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uploaded </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Upload finished successfully.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error during the upload: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>xhr<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>具体的实例演示可查看：<a href="https://zh.javascript.info/xmlhttprequest#shang-chuan-jin-du" target="_blank" rel="noopener noreferrer">带有进度指示的文件上传<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="跨域请求">跨域请求</h4> <p><code>XMLHttpRequest</code> 可以使用 CORS 策略进行<a href="#%E8%B7%A8%E6%BA%90%E8%AF%B7%E6%B1%82">跨源请求</a>，要启用它们可以将属性 <code>xhr.withCredentials</code> 设置为 <code>true</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://anywhere.com/request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre></div><h3 id="中止请求">中止请求</h3> <p>可以随时调用方法 <code>xhr.abort()</code> 终止请求，它会触发 <code>abort</code> 事件，且 <code>xhr.status</code> 变为 <code>0</code></p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 终止请求</span>
</code></pre></div><h3 id="状态">状态</h3> <p>对象 <code>xhr</code> 的状态 state 会随着它的处理进度变化而变化，可以通过属性 <code>xhr.readyState</code> 来了解当前状态。在<a href="https://xhr.spec.whatwg.org/#states" target="_blank" rel="noopener noreferrer">规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中提到的对象 <code>xhr</code> 共有 5 个状态，分别用数值表示对应于一种状态，<strong>当对象 <code>xhr</code> 状态发生变化时事件 <code>readystatechange</code> 就会被触发</strong></p> <ul><li><code>UNSENT = 0</code> 初始状态</li> <li><code>OPENED = 1</code> 方法 <code>open()</code> 被调用</li> <li><code>HEADERS_RECEIVED = 2</code> 接收到 response header</li> <li><code>LOADING = 3</code> 响应正在被加载（接收到一个数据包）</li> <li><code>DONE = 4</code> 请求完成</li></ul> <p>在实际的网络请求过程中，对象 <code>xhr</code> 状态以 <code>0</code> → <code>1</code> → <code>2</code> → <code>3</code> → … → <code>3</code> → <code>4</code> 的顺序转变，每当通过网络接收到一个数据包，就会重复一次状态 <code>3</code>。</p> <p>💡 可以通过监听事件 <code>readystatechange</code>来跟踪该过程。可能在非常老的代码中找到 <code>readystatechange</code> 这样的事件监听器，它的存在是有历史原因的，因为那时没有 <code>load</code> 以及其他事件，如今它已被 <code>load/error/progress</code> 事件处理程序所替代。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加载中</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求完成</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="响应">响应</h3> <p>一旦服务器返回响应，我们访问 <code>xhr</code> 对象的属性获取更详细的信息</p> <ul><li>属性 <code>status</code>HTTP 状态码（一个数字），如 <code>200</code>，<code>404</code>，<code>403</code> 等，如果出现<strong>非 HTTP 错误</strong>则为 <code>0</code>（如果是 HTTP 错误返回状态码是 <code>40*</code> 形式）。</li> <li>属性 <code>statusText</code> HTTP 状态消息（一个字符串） 与状态码相对应，如 <code>200</code> 对应于 <code>OK</code>，<code>404</code> 对应于 <code>Not Found</code>，<code>403</code> 对应于 <code>Forbidden</code> 等。</li> <li>属性 <code>response</code>（旧脚本可能用的是 <code>responseText</code>）服务器响应体 response body。</li></ul> <p>⚠️ 请求返回像 <code>404</code> 这样的 HTTP 错误响应，虽然无法获取资源也算是访问成功，依然可以调用 XHR 对象属性 <code>onload</code> 设置的处理程序</p> <h4 id="处理成功请求-onload">处理成功请求 onload</h4> <p>XHR 对象 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestEventTarget/onload" target="_blank" rel="noopener noreferrer"><code>onload</code> 属性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是请求成功完成时才调用的函数，通过该属性可以设置请求成功后的操作</p> <div class="language-js extra-class"><pre class="language-js"><code>XMLHttpRequest<span class="token punctuation">.</span>onload <span class="token operator">=</span> callback<span class="token punctuation">;</span> <span class="token comment">// callback 是请求成功完成时要执行的函数，</span>
</code></pre></div><p>💡 处理程序中的 <code>this</code> 指代 XHR 对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 请求成功时将响应消息（如 HTML 文件）在终端打印出来</span>
<span class="token keyword">function</span> <span class="token function">handleSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this 指代 XHR 对象</span>
    <span class="token comment">// this.responseText 保存来自服务器的响应内容</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

asyncRequestObject<span class="token punctuation">.</span>onload <span class="token operator">=</span> handleSuccess<span class="token punctuation">;</span> <span class="token comment">// 请求成功时执行 handleSuccess 函数</span>
</code></pre></div><p>⚠️ 使用 XHR 对象的 <code>.responseText</code> 属性以获取响应的文本，如网页的 HTML 文件。</p> <h4 id="处理错误-onerror">处理错误 onerror</h4> <p>XHR 对象 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestEventTarget/onerror" target="_blank" rel="noopener noreferrer"><code>onerror</code> 属性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是请求无法实现时才调用的函数，可以设置请求失败时执行的操作</p> <div class="language-js extra-class"><pre class="language-js"><code>XMLHttpRequest<span class="token punctuation">.</span>onerror <span class="token operator">=</span> callback<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleError</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">'出现错误 😞'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

asyncRequestObject<span class="token punctuation">.</span>onerror <span class="token operator">=</span> handleError<span class="token punctuation">;</span> <span class="token comment">// 请求失败时执行 handleError 函数</span>
</code></pre></div><h4 id="响应类型">响应类型</h4> <p>除了访问服务器获取网站的 HTML 文件之外，还可以获取其他格式的数据。可以使用 <code>xhr</code> 对象属性 <code>xhr.responseType</code> （预先，使用方法 <code>xhr.send()</code> 发送请求之前）设置响应格式，以便 JavaScript 对响应体进行合适的处理：</p> <ul><li><code>&quot;&quot;</code>（默认） 响应格式为字符串，</li> <li><code>&quot;text&quot;</code> 响应格式为字符串，</li> <li><code>&quot;arraybuffer&quot;</code> 响应格式为 <code>ArrayBuffer</code></li> <li><code>&quot;blob&quot;</code> 响应格式为 <code>Blob</code></li> <li><code>&quot;document&quot;</code> 响应格式为 XML document（可以使用 XPath 和其他 XML 方法）</li> <li><code>&quot;json&quot;</code> 响应格式为 JSON（自动解析）<a href="/tech-blog/web/Network/JSON.html">JSON</a> 是网络传输常见的数据格式</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/article/xmlhttprequest/example/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 预设返回数据类型</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 由于预设了返回的数据类型为 JSON，JavaScript 自动解析响应</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> responseObj <span class="token operator">=</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>responseObj<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, world!</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以使用 JavaScript 内建的函数 <code>JSON.parse()</code> （手动）解析 JSON 数据并转换为 JavaScript 对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleSuccess</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 使用函数 JSON.parse() 将数据从 JSON 格式转换为 JavaScript 对象</span>
   <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseText <span class="token punctuation">)</span><span class="token punctuation">;</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

asyncRequestObject<span class="token punctuation">.</span>onload <span class="token operator">=</span> handleSuccess<span class="token punctuation">;</span>
</code></pre></div><p>💡 在旧的脚本中，可能会看到 <code>xhr.responseText</code>，甚至会看到 <code>xhr.responseXML</code> 属性。它们是由于历史原因而存在的，以获取字符串或 XML 文档。如今应该通过属性 <code>xhr.responseType</code> 设置格式，然后就可以直接使用通用的属性 <code>xhr.response</code> 访问不同数据。</p> <h2 id="fetch">fetch</h2> <p>参考： <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="noopener noreferrer">使用 Fetch - Web API 接口参考 | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>现代通用的发送网络请求的方法是 Fetch，这是新的 JavaScript API 旨在让资源请求（通常是网络请求）简单很多，<strong>其核心是基于 <code>promise</code> 处理异步请求</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>参数说明：</p> <ul><li><strong><code>url</code></strong> 要访问的 URL。</li> <li><strong><code>options</code></strong> 可选参数，是一个称为 init 对象/配置对象，具有属性 <code>method</code>，<code>header</code> 等，用于设置 HTTP 请求的头部信息。</li></ul> <p>典型的 fetch 请求由两个 <code>await</code> 调用组成或以 <code>promise</code> 形式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 形式一：使用 await 关键字</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析 response header</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 body 读取为 json</span>

<span class="token comment">// 形式二：使用 promise 链式调用</span>
<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token comment">/* process result */</span><span class="token punctuation">)</span>
</code></pre></div><p>通过 Fetch 发送请求并处理响应的过程：</p> <ol><li><p>创建 <code>fetch(url)</code> 函数并提供了 <code>url</code> 后浏览器会立即向服务器发送网络请求，（无论请求成功与否）并立即返回一个 <a href="/tech-blog/web/JavaScript/语法基础/promise.html">Promise 对象</a></p></li> <li><p>当服务器返回响应头 response header 时，<code>promise</code> 对象就使用内建的 <a href="https://fetch.spec.whatwg.org/#response-class" target="_blank" rel="noopener noreferrer">Response<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> class 对象来对响应头进行解析，通过响应头来检查 HTTP 状态以确定请求是否成功（当前还没有响应体 response body）。</p> <ul><li>如果 <code>fetch</code> 无法建立一个 HTTP 请求，如网络问题或是请求的网址不存在，就会抛出错误，即 <code>promise</code> 就会 reject</li> <li>如果请求成功 <code>promise</code> 就会 resolve，则可以访问 <strong><code>response</code> 对象的属性 <code>status</code>，属性值会在特定范围中，如 <code>200</code></strong>；如果 HTTP 状态码 200-299，则 <code>request</code> 对象的属性 <code>ok</code> 为 <code>true</code></li></ul> <p>⚠️ 异常的 HTTP 状态，如响应头 <code>status</code> 为 <code>404</code> 或 <code>500</code> 也是请求成功的一种情况，所以不会导致出现 <code>error</code></p></li> <li><p>基于 <code>promise</code> 对象的状态通过链式调用执行<strong>方法 <code>then()</code> 或 <code>catch()</code></strong>，如果请求成功就会返回 <code>response</code> 对象，可基于 response body 的数据格式调用 <code>response</code> 对象的<a href="#%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F">不同方法</a>进行解析。</p></li></ol> <p>💡 可访问 <a href="http://caniuse.com/#feat=fetch" target="_blank" rel="noopener noreferrer">caniuse<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 查看当前浏览器是否支持 Fetch API，如果你的浏览器不支持只需向你的项目中添加 <a href="https://github.com/github/fetch" target="_blank" rel="noopener noreferrer">polyfill<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>⚠️ Fetch 请求依然需要遵守<a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">同源策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的限制，默认情况下只能对与加载数据在同一网域中的资源和数据发出请求。</p> <h3 id="request-header">Request header</h3> <p>在函数 <code>fetch()</code> 的第二个参数（可选）配置对象的属性 <code>header</code> 中设置 HTTP 请求的头部信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'key'</span><span class="token operator">:</span> value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>💡 可以使用 Fetch API 提供的接口/构造函数 <code>Headers</code> 创建一个 HTTP 请求头，一般步骤是</p> <ol><li>使用构造函数 <code>Header()</code> 创建新 <code>header</code> 对象</li> <li>（以键值对的形式，类似于 Map）通过 <code>append()</code> 方法将信息添加到 <code>header</code> 对象中</li> <li>将该 <code>header</code> 对象作为（<code>fetch()</code> 函数的第二个参数）配置对象的属性 <code>headers</code> 的值</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> requestHeaders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> requestHeaders
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>⚠️ 有一些 header 对象的属性无法设置，这些 header 属性保证了 HTTP 的正确性和安全性，所以它们仅由浏览器控制，详见 <a href="https://fetch.spec.whatwg.org/#forbidden-header-name" target="_blank" rel="noopener noreferrer">forbidden HTTP headers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><code>Accept-Charset</code>, <code>Accept-Encoding</code></li> <li><code>Access-Control-Request-Headers</code></li> <li><code>Access-Control-Request-Method</code></li> <li><code>Connection</code></li> <li><code>Content-Length</code></li> <li><code>Cookie</code>, <code>Cookie2</code></li> <li><code>Date</code></li> <li><code>DNT</code></li> <li><code>Expect</code></li> <li><code>Host</code></li> <li><code>Keep-Alive</code></li> <li><code>Origin</code></li> <li><code>Referer</code></li> <li><code>TE</code></li> <li><code>Trailer</code></li> <li><code>Transfer-Encoding</code></li> <li><code>Upgrade</code></li> <li><code>Via</code></li> <li><code>Proxy-*</code></li> <li><code>Sec-*</code></li></ul> <h4 id="fetch-api">Fetch API</h4> <p>fetch 提供<a href="https://zh.javascript.info/fetch-api" target="_blank" rel="noopener noreferrer">多种选项<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以更好地配置网络请求</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token comment">// POST，PUT，DELETE，等。</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内容类型 header 值通常是自动设置的</span>
    <span class="token comment">// 取决于 request body</span>
    <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text/plain;charset=UTF-8&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token comment">// string，FormData，Blob，BufferSource，或 URLSearchParams</span>
  referrer<span class="token operator">:</span> <span class="token string">&quot;about:client&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 或 &quot;&quot; 以不发送 Referer header，</span>
  <span class="token comment">// 或者是当前源的 url</span>
  referrerPolicy<span class="token operator">:</span> <span class="token string">&quot;no-referrer-when-downgrade&quot;</span><span class="token punctuation">,</span> <span class="token comment">// no-referrer，origin，same-origin...</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;cors&quot;</span><span class="token punctuation">,</span> <span class="token comment">// same-origin，no-cors</span>
  credentials<span class="token operator">:</span> <span class="token string">&quot;same-origin&quot;</span><span class="token punctuation">,</span> <span class="token comment">// omit，include</span>
  cache<span class="token operator">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token comment">// no-store，reload，no-cache，force-cache，或 only-if-cached</span>
  redirect<span class="token operator">:</span> <span class="token string">&quot;follow&quot;</span><span class="token punctuation">,</span> <span class="token comment">// manual，error</span>
  integrity<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 一个 hash，像 &quot;sha256-abcdef1234567890&quot;</span>
  keepalive<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// true</span>
  signal<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// AbortController 来中止请求</span>
  window<span class="token operator">:</span> window <span class="token comment">// null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="更改-http-方法">更改 HTTP 方法</h4> <p>Fetch 请求的默认 HTTP 方法是 GET，可以通过 <code>fetch()</code> 的配置对象的属性 <code>method</code> 设置其他的 HTTP 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用 POST 方法</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果使用 POST 发送网络请求，则需要提供 请求体 request body，通过 <code>fetch()</code> 的配置对象的属性 <code>body</code> 进行设置</p> <p><strong><code>body</code></strong> 属性值可以有多种数据类型，常见的格式如下：</p> <ul><li>字符串，一般以 JSON 格式进行编码（最常用）</li> <li><code>FormData</code> 对象，以 <code>form/multipart</code> 形式发送数据</li> <li><code>Blob</code>/<code>BufferSource</code> 发送二进制数据</li> <li><a href="https://zh.javascript.info/url" target="_blank" rel="noopener noreferrer">URLSearchParams<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 以 <code>x-www-form-urlencoded</code> 编码形式发送数据（很少使用）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以 JSON 形式发送 user 对象</span>
<span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span>
  surname<span class="token operator">:</span> <span class="token string">'Smith'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/article/fetch/post/user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json;charset=utf-8'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// User saved.</span>
</code></pre></div><p>💡 请注意如果请求的 <code>body</code> 是字符串，则 <code>Content-Type</code> 会默认设置为 <code>text/plain;charset=UTF-8</code>；但是当要发送 JSON 时，需要将 <code>headers</code> 的属性 <code>Content-Type</code> 设置为 <code>application/json</code>，因为这是 JSON 编码的数据的正确的 <code>Content-Type</code>。</p> <h4 id="formdata">FormData</h4> <p>在商业网站中最常见和实用的数据传输/请求就是表单数据，使用 <a href="https://xhr.spec.whatwg.org/#interface-formdata" target="_blank" rel="noopener noreferrer">FormData<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象可以提供帮助。</p> <p>FormData 是 HTML 表单数据的对象，通过构造函数 <code>FormData()</code> 创建，可以提供 HTML 元素 <code>form</code> 作为其参数，这样 FormData 对象会自动捕抓其中的表单字段/控件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">[</span>form<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>💡 向服务器传递 <code>FormData</code> 对象时，如使用方法<code>fetch()</code>（将其设置为函数 <code>fetch()</code> 的第二个参数配置对象的属性 <code>body</code> 值），它会被编码并发送出去（这个编码允许发送文件，因此 <code>&lt;input type=&quot;file&quot;&gt;</code> 字段也能被发送），并带有 <code>Content-Type: multipart/form-data</code>（因此不需要设置 <code>fetch()</code> 第二个参数对象的属性 <code>Content-Type</code>），这样从服务器角度来看，它就像是一个普通的表单提交。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>formElem<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>John<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>surname<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Smith<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  formElem<span class="token punctuation">.</span><span class="token function-variable function">onsubmit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/article/formdata/post/user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      body<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>formElem<span class="token punctuation">)</span>   <span class="token comment">// 发送表单 formElem</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以使用以下方法修改 <code>FormData</code> 中的字段/控件</p> <ul><li><code>formData.append(name, value)</code> 添加具有给定 <code>name</code> 和 <code>value</code> 的表单字段，</li> <li><code>formData.append(name, blob, fileName)</code> 添加一个文件类型字段（动态生成的二进制数据），相当于 <code>&lt;input type=&quot;file&quot;&gt;</code>，第三个参数 <code>fileName</code> 设置文件名（而不是表单字段名），它是用户文件系统中文件的名称</li> <li><code>formData.delete(name)</code> 移除带有给定 <code>name</code> 的字段</li> <li><code>formData.get(name)</code> 获取带有给定 <code>name</code> 的字段值</li> <li><code>formData.has(name)</code> 如果存在带有给定 <code>name</code> 的字段，则返回 <code>true</code>，否则返回 <code>false</code></li></ul> <p>💡 从技术上来讲，一个表单可以包含多个具有相同 <code>name</code> 的字段，因此多次调用 <code>append</code> 将会添加多个具有相同名称的字段。</p> <p>而类似于 <code>append</code> 的方法 <code>set</code> <strong>移除所有具有给定 <code>name</code> 的字段，然后附加一个新字段</strong>，因此它确保了只有一个具有这种 <code>name</code> 的字段</p> <ul><li><code>formData.set(name, value)</code>，</li> <li><code>formData.set(name, blob, fileName)</code>。</li></ul> <p>💡 可以使用 <code>for..of</code> 循环迭代 formData 字段</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'key1'</span><span class="token punctuation">,</span> <span class="token string">'value1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'key2'</span><span class="token punctuation">,</span> <span class="token string">'value2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过解构获取 key/value 对</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> formData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// key1=value1，然后是 key2=value2</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="下载进度">下载进度</h3> <p>通过方法 <code>fetch()</code> 发送的网络请求，支持使用 <code>response.body</code> 的方法跟踪下载进度，<code>response.body</code> 是 <a href="https://streams.spec.whatwg.org/#rs-class" target="_blank" rel="noopener noreferrer"><code>ReadableStream</code> 对象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，类似于 与 <code>response.text()</code>，<code>response.json()</code> 和其他方法可读取响应体，但 <code>response.body</code> 可以通过方法，如 <code>read()</code> 逐块 chunk 读取并监控下载进度。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建一个流读取器 stream reader 读取响应体，代替 response.json() 以及其他方法</span>
<span class="token keyword">const</span> reader <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在循环中接收响应块 response chunk，并读取每次接受块字节的大小，直到加载完成</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当最后一块下载完成时，done 值为 true</span>
  <span class="token comment">// value 是块字节</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>done<span class="token punctuation">,</span> value<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更详细地控制下载进度（并将响应块「复原」为响应体）的实例可查看 <a href="https://zh.javascript.info/fetch-progress" target="_blank" rel="noopener noreferrer">Fetch：下载进度<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>💡 到目前为止方法 <code>fetch</code> 无法跟踪上传进度，可使用方法 <code>XMLHttpReques</code> 发送网络请求以监听上传进度</p> <h3 id="中止请求-2">中止请求</h3> <p>方法 <code>fetch</code> 核心是基于 promise 处理网络请求，如果想中止网络请求，但在 JavaScript 通常并没有「中止」 promise 的概念，我们可以借用特殊的内建对象 AbortController 来实现。</p> <p>内建对象 AbortController 可用于中止异步任务，包括 <code>fetch()</code> 发起的网络请求。使用构建函数 <code>AbortController</code> 创建控制器，该对象只有单一的方法 <code>abort()</code> 和单一属性 <code>signal</code>。</p> <p>当控制器调用 <code>abort()</code> 方法时，事件 <code>abort</code> 就会在 <code>controller.signal</code> 上触发，同时 <code>controller.signal.aborted</code> 属性变为 <code>true</code>。因此可以在 <code>controller.signal</code> 上设置监听器来跟踪事件 <code>abort</code>，并执行相应的处理程序中止 <code>promise</code>；而方法 <code>fetch</code> 在内部集成了它，只要将 <code>controller.signal</code> 作为函数 <code>fetch()</code> 的第二个参数配置对象的属性 <code>signal</code> 的值即可实现监控。</p> <p>中止方法 <code>fetch</code> 发起的网络请求步骤：</p> <ol><li><p>创建一个控制器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>将 <code>signal</code> 属性传递给 <code>fetch</code> 选项，它会监听 <code>signal</code> 上的事件 <code>abort</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  signal<span class="token operator">:</span> controller<span class="token punctuation">.</span>signal
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>调用 <code>controller.abort()</code> 来中止</p> <div class="language-js extra-class"><pre class="language-js"><code>controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>💡 当一个异步程序被中止时，promise 就会变成 reject 状态并返回一个 <code>AbortError</code> 异常，我们可以捕抓该异常并对其进行处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 秒后中止</span>
<span class="token keyword">let</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/article/fetch-abort/demo/hang'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    signal<span class="token operator">:</span> controller<span class="token punctuation">.</span>signal
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'AbortError'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// handle abort()</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Aborted!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>💡 AbortController 是<strong>可扩展</strong>的，即控制器可以分配给多个 fetch 或其他异步任务（需要手动设置监听器来监听事件 <code>abort</code> 触发 promise 状态变成 reject），实现一次中止多个网络请求。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 要并行 fetch 的 url 列表</span>
<span class="token keyword">let</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> ourJob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>   <span class="token comment">// 其他异步任务</span>
  <span class="token comment">// ...</span>
  controller<span class="token punctuation">.</span>signal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 设置事件 abort 监听器</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> fetchJobs <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>   <span class="token comment">// fetches</span>
  signal<span class="token operator">:</span> controller<span class="token punctuation">.</span>signal
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等待完成所有异步任务任务和 fetch 发起的网络请求</span>
<span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>fetchJobs<span class="token punctuation">,</span> ourJob<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果 controller.abort() 被从其他地方调用，</span>
<span class="token comment">// 它将中止所有 fetch 和 ourJob</span>
</code></pre></div><h3 id="处理程序">处理程序</h3> <p>Fetch 基于 Promise，当我们发出 Fetch 请求时，它将自动返回一个 promise 对象，我们可以对其进行监听响应，即通过链式调用为该 promise 对象设置方法 <code>then()</code> 或 <code>catch()</code></p> <p>当 Fetch 请求 <code>resolve</code> 时就会将 <code>Response</code> 对象作为 promise 对象的结果，同时会调用 <code>.then()</code> 方法执行处理程序；如果请求发生错误就会调用 <code>.catch()</code> 方法并执行处理程序。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当响应的主体数据格式为 JSON 时，对响应对象调用方法 json()</span>
<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// response 为响应对象，从中提取响应（主体）数据</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>💡 <code>Response</code> 对象上有多种基于 promise 的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch#Body" target="_blank" rel="noopener noreferrer">方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，每个方法对应处理<a href="https://davidwalsh.name/fetch" target="_blank" rel="noopener noreferrer">不同数据类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以访问 response body</p> <ul><li><code>response.json()</code> 将 response 解析为 JSON</li> <li><code>response.text()</code> 读取 response，并以文本形式返回 response</li> <li><code>response.blob()</code> 以 <a href="https://zh.javascript.info/blob" target="_blank" rel="noopener noreferrer">Blob<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（具有类型的二进制数据）形式返回，如图片文件</li> <li><code>response.formData()</code> 以 <code>FormData</code> 对象的形式返回 response</li> <li><code>response.arrayBuffer()</code> 以 <a href="https://zh.javascript.info/arraybuffer-binary-arrays" target="_blank" rel="noopener noreferrer">ArrayBuffer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（低级别的二进制数据）形式返回 response</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用 promise 链式调用获取 JSON 格式的 response body</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">commits</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span>commits<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>author<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*---------- 分割线 ----------*/</span>
<span class="token comment">// 使用 awite 方法，获取 JSON 格式的 response body</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> commits <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取 response body，并将其解析为 JSON</span>
<span class="token function">alert</span><span class="token punctuation">(</span>commits<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>author<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*---------- 分割线 ----------*/</span>
<span class="token comment">// 使用方法 response.text() 获取纯文本格式的 response body</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 response body 读取为文本</span>
<span class="token function">alert</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 截取前80个字符</span>
</code></pre></div><p>⚠️ 只能选择一种读取 body 的方法，如使用了 <code>response.text()</code> 方法来获取 response，那么如果再用 <code>response.json()</code> 则不会生效，因为 body 内容已经被处理过了。</p> <h3 id="response-header">Response header</h3> <p>使用响应对象属性 <code>response.headers</code> 访问 Response header 响应表头，它类似于 Map （但不是真正的 Map）具有类似的方法，即按键/名称 name 获取各个值 header，或使用循环结构迭代其中的元素。</p> <div class="language-html extra-class"><pre class="language-html"><code>let response = await fetch('https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits');

// 获取一个 header
alert(response.headers.get('Content-Type')); // application/json; charset=utf-8

// 迭代所有 header
for (let [key, value] of response.headers) {
  alert(`${key} = ${value}`);
}
</code></pre></div><h2 id="跨源请求">跨源请求</h2> <p>Cross-Origin Resource Sharing，CORS 跨源资源共享是指那些发送到其他域（即使是子域）、协议或端口的请求，需要远程服务器必须提供表示允许获取的 header <code>Access-Control-Allow-Origin</code>。</p> <p>💡 这里的源 origin 包括域 domain/端口 port/协议 protocol 的组合，只要网络请求中其中之一与目前加载数据来源不同就是<strong>跨源</strong>。起初出于安全考虑跨源请求 CORS 是被禁止的，为了保护互联网以免受黑客攻击，如位于 https://facebook.com 的脚本无法读取位于 https://gmail.com 的用户邮箱的内容。但为了资源互通流动需要在必要时打破这种限制，经过长时间的讨论跨源请求被允许了，但是任何新功能都需要服务器明确允许，即服务器必须提供表示允许获取的 header <code>Access-Control-Allow-Origin</code></p> <p>有两种类型的跨域请求：简单的请求和所有其他请求。<strong>本质区别在于，可以使用 <code>&lt;form&gt;</code> 或 <code>&lt;script&gt;</code> 进行「简单请求」，而无需任何其他特殊方法。</strong></p> <h3 id="简单请求">简单请求</h3> <p>一个 <a href="http://www.w3.org/TR/cors/#terminology" target="_blank" rel="noopener noreferrer">简单的请求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是指满足以下两个条件的请求</p> <ul><li><a href="http://www.w3.org/TR/cors/#simple-method" target="_blank" rel="noopener noreferrer">简单的方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>GET</code>，<code>POST</code> 或 <code>HEAD</code></li> <li><a href="http://www.w3.org/TR/cors/#simple-header" target="_blank" rel="noopener noreferrer">简单的 header<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 仅允许自定义下列 header：
<ul><li><code>Accept</code>，</li> <li><code>Accept-Language</code>，</li> <li><code>Content-Language</code>，</li> <li><code>Content-Type</code> 的值为 <code>application/x-www-form-urlencoded</code>，<code>multipart/form-data</code> 或 <code>text/plain</code>。</li></ul></li></ul> <p>如果一个请求是跨源的，浏览器始终会向 HTTP 请求添加 <code>Origin</code> header，它包含了确切的源 domain/protocol/port 但没有路径。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 从 https://javascript.info/page 请求 https://anywhere.com/request 的 header</span>
<span class="token constant">GET</span> <span class="token operator">/</span>request
Host<span class="token operator">:</span> anywhere<span class="token punctuation">.</span>com
Origin<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>javascript<span class="token punctuation">.</span>info
<span class="token operator">...</span>
</code></pre></div><p>然后服务器接收到该请求时可以检查 <code>Origin</code>，如果同意接受这样的请求，就会在响应中添加一个特殊的 header <code>Access-Control-Allow-Origin</code>，该 header 包含了允许的源（在我们的示例中是 <code>https://javascript.info</code>）或者一个星号 <code>*</code>，然后响应成功，否则报错。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 带有服务器许可的响应</span>
<span class="token number">200</span> <span class="token constant">OK</span>
Content<span class="token operator">-</span>Type<span class="token operator">:</span>text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>javascript<span class="token punctuation">.</span>info
</code></pre></div><p>对于跨源请求，默认情况下 JavaScript 只能访问「简单」response header，访问任何其他 response header 都将导致 <code>error</code></p> <ul><li><code>Cache-Control</code></li> <li><code>Content-Language</code></li> <li><code>Content-Type</code></li> <li><code>Expires</code></li> <li><code>Last-Modified</code></li> <li><code>Pragma</code></li></ul> <p>⚠️ 上述列表中没有 <code>Content-Length</code> header，它包含完整的响应长度用于跟踪下载进度百分比。要授予 JavaScript 对任何其他 response header 的访问权限，服务器必须发送 <code>Access-Control-Expose-Headers</code> 的 header，它包含一个以逗号分隔的应该被设置为可访问的非简单 header 名称列表。</p> <p>浏览器扮演受被信任的中间人的角色，决定是否允许跨源请求的发送：</p> <ul><li>它确保发送的跨源请求带有正确的 <code>Origin</code></li> <li>它检查响应中的许可 <code>Access-Control-Allow-Origin</code> 是否存在，如果存在则允许 JavaScript 访问响应，否则将失败并报错</li></ul> <p><img src="/tech-blog/assets/img/20200513103736982_28256.41d8f8ad.png" alt="CORS"></p> <h3 id="非简单请求">非简单请求</h3> <p>除了满足简单请求限制的两种条件的请求以外，任何其他请求都被认为是「非简单请求」，如具有 <code>PUT</code> 方法或 <code>API-Key</code> HTTP-header 的请求。</p> <p>之前没有人能够设想网页能发出这些复杂的非简单请求，因此当我们尝试发送一个非简单请求时，<strong>浏览器会发送一个特殊的「预检」preflight 请求到服务器</strong>，以询问服务器是否接受此类跨源请求，除非服务器明确通过 header 进行确认，否则非简单请求不会被发送。</p> <p>预检请求使用 <code>OPTIONS</code> 方法，它没有 body，但是有两个 header：</p> <ul><li><code>Access-Control-Request-Method</code> header 带有非简单请求的方法。</li> <li><code>Access-Control-Request-Headers</code> header 提供一个以逗号分隔的非简单 HTTP-header 列表。</li></ul> <p>如果服务器同意处理请求那么它会进行响应，此响应的状态码应该为 <code>200</code>，没有 body，具有 header：</p> <ul><li><code>Access-Control-Allow-Methods</code> 必须具有允许的方法。</li> <li><code>Access-Control-Allow-Headers</code> 必须具有一个允许的 header 列表。</li> <li><code>Access-Control-Max-Age</code> header 可以指定缓存此权限的秒数，因此浏览器不是必须为满足给定权限的后续请求发送预检。</li></ul> <p><img src="/tech-blog/assets/img/20200513105447526_13159.2716f3da.png" alt="No-simple requests"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 发送非简单请求</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://site.com/service.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'PATCH'</span><span class="token punctuation">,</span>   <span class="token comment">// 方法 PATCH 并非简单请求限制三个中之一</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>   <span class="token comment">// Content-Type 不是简单请求限制三个中之一</span>
    <span class="token string">'API-Key'</span><span class="token operator">:</span> <span class="token string">'secret'</span>   <span class="token comment">// 含有 API-Key header</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>非简单跨域请求步骤：</p> <ol><li><p>在发送请求前，浏览器会自己发送预检请求 preflight request</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">OPTIONS</span> <span class="token operator">/</span>service<span class="token punctuation">.</span>json
Host<span class="token operator">:</span> site<span class="token punctuation">.</span>com
Origin<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>javascript<span class="token punctuation">.</span>info
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Method<span class="token operator">:</span> <span class="token constant">PATCH</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Headers<span class="token operator">:</span> Content<span class="token operator">-</span>Type<span class="token punctuation">,</span><span class="token constant">API</span><span class="token operator">-</span>Key
</code></pre></div><ul><li>方法：<code>OPTIONS</code></li> <li>路径与主请求完全相同：<code>/service.json</code></li> <li>特殊跨源头：
<ul><li><code>Origin</code> 来源。</li> <li><code>Access-Control-Request-Method</code> 请求方法。</li> <li><code>Access-Control-Request-Headers</code> 以逗号分隔的「非简单」header 列表。</li></ul></li></ul> <p>💡 预检请求发生在后台，它对 JavaScript 不可见。JavaScript 仅获取对主请求的响应，如果没有服务器许可，则获得一个 error。</p></li> <li><p>服务应返回预检响应</p> <p>当服务应响应状态 <code>200</code> 并包括以下 header 就表示允许后续通信，否则会触发错误。</p> <ul><li><code>Access-Control-Allow-Methods: PATCH</code></li> <li><code>Access-Control-Allow-Headers: Content-Type,API-Key</code>。</li></ul> <p>当浏览器看到 <code>PATCH</code> 在 <code>Access-Control-Allow-Methods</code> 中，<code>Content-Type,API-Key</code> 在列表 <code>Access-Control-Allow-Headers</code> 中，它将发送主请求。</p> <p>💡 如果服务器将来期望其他方法和 header 可以通过添加到列表中来预先允许它们</p> <div class="language-http extra-class"><pre class="language-http"><code>200 OK
<span class="token header-name keyword">Access-Control-Allow-Methods:</span> PUT,PATCH,DELETE
<span class="token header-name keyword">Access-Control-Allow-Headers:</span> API-Key,Content-Type,If-Modified-Since,Cache-Control
<span class="token header-name keyword">Access-Control-Max-Age:</span> 86400
</code></pre></div><p>💡 此外预检响应会<strong>缓存一段时间</strong>，该时间由 <code>Access-Control-Max-Age</code> header 指定（86400 秒，一天），因此后续请求将不会导致预检。假设它们符合缓存的配额，则将直接发送它们。</p></li> <li><p>预检成功后，浏览器现在发出主请求，其算法与简单请求的算法相同，主请求具有 <code>Origin</code> header（因为它是跨源的）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">PATCH</span> <span class="token operator">/</span>service<span class="token punctuation">.</span>json
Host<span class="token operator">:</span> site<span class="token punctuation">.</span>com
Content<span class="token operator">-</span>Type<span class="token operator">:</span> application<span class="token operator">/</span>json
<span class="token constant">API</span><span class="token operator">-</span>Key<span class="token operator">:</span> secret
Origin<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>javascript<span class="token punctuation">.</span>info
</code></pre></div></li> <li><p>服务器作出主响应，需要添加 <code>Access-Control-Allow-Origin</code>，然后 JavaScript 可以读取主服务器响应了。</p> <div class="language-js extra-class"><pre class="language-js"><code>Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>javascript<span class="token punctuation">.</span>info
</code></pre></div></li></ol> <h3 id="凭据">凭据</h3> <p>默认情况下，跨源请求不会带来任何凭据（cookies 或者 HTTP 认证（HTTP authentication））。</p> <p>这对于 HTTP 请求来说并不常见。通常，对 <code>http://site.com</code> 的请求附带有该域的所有 cookie。但是由 JavaScript 方法发出的跨源请求是个例外,如 <code>fetch('http://another.com')</code> 不会发送任何 cookie，即使那些 (!) 属于 <code>another.com</code> 域的 cookie。</p> <p>这是因为具有凭据的请求比没有凭据的请求要强大得多。如果被允许，它会使用它们的凭据授予 JavaScript 代表用户行为和访问敏感信息的全部权力。它必须显式地带有允许请求的凭据和附加 header。要在 <code>fetch</code> 中发送凭据，我们需要添加 <code>credentials: &quot;include&quot;</code> 选项，现在，<code>fetch</code> 将把源自 <code>another.com</code> 的 cookie 和我们的请求发送到该网站。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://another.com'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  credentials<span class="token operator">:</span> <span class="token string">&quot;include&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果服务器同意接受 <strong>带有凭据</strong> 的请求，则除了 <code>Access-Control-Allow-Origin</code> 外，服务器还应该在响应中添加 header <code>Access-Control-Allow-Credentials: true</code>。</p> <div class="language-http extra-class"><pre class="language-http"><code>200 OK
<span class="token header-name keyword">Access-Control-Allow-Origin:</span> https://javascript.info
<span class="token header-name keyword">Access-Control-Allow-Credentials:</span> true
</code></pre></div><p>⚠️ 对于具有凭据的请求，禁止 <code>Access-Control-Allow-Origin</code> 使用星号 <code>*</code>。如上所示，它必须有一个确切的源。这是另一项安全措施，以确保服务器真的知道它信任的发出此请求的是谁。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2/19/2021, 10:30:01 AM</span></div></footer> <!----> </main></div> <div class="catalog-container absolute top-0 right-0 h-full hidden lg:block" style="width:0px;"><div class="headings-list-container sticky top-36" data-v-cceeb8de><ul class="m-2 lg:pl-7 xl:pl-11 py-7 opacity-60 hover:opacity-100 transition-all duration-300" data-v-cceeb8de></ul></div></div></div> <div class="catalog-btn hidden sticky bottom-16 lg:flex justify-end items-center mb-4"><button class="focus:outline-none"><div class="p-2 flex justify-center items-center rounded-l-md bg-gray-300 text-white transition-all duration-500 bg-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg> <span class="pl-2 hidden text-xs" style="display:none;">显示目录</span> <span class="pl-2 hidden text-xs" style="display:;">关闭目录</span></div></button></div> <div class="scroll-to-top hidden sticky bottom-6 lg:flex justify-end items-center mb-4" data-v-73a2269d><button data-v-73a2269d><div class="p-2 flex justify-center items-center rounded-l-md bg-gray-300 text-white hover:bg-gray-600 transition-all duration-500" data-v-73a2269d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" data-v-73a2269d><path fill-rule="evenodd" d="M7.776 5.553a.5.5 0 0 1 .448 0l6 3a.5.5 0 1 1-.448.894L8 6.56 2.224 9.447a.5.5 0 1 1-.448-.894l6-3z" data-v-73a2269d></path></svg> <span class="pl-2 hidden text-xs" data-v-73a2269d>返回顶部</span></div></button></div> <div class="more-btns lg:hidden sticky bottom-6 flex justify-end items-center mb-4" style="display:;"><div class="py-1 flex justify-center items-center rounded-l-md text-white transition-all duration-500 bg-gray-300"><button class="p-2" style="display:;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M9.224 1.553a.5.5 0 0 1 .223.67L6.56 8l2.888 5.776a.5.5 0 1 1-.894.448l-3-6a.5.5 0 0 1 0-.448l3-6a.5.5 0 0 1 .67-.223z"></path></svg></button> <button class="p-2" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6.776 1.553a.5.5 0 0 1 .671.223l3 6a.5.5 0 0 1 0 .448l-3 6a.5.5 0 1 1-.894-.448L9.44 8 6.553 2.224a.5.5 0 0 1 .223-.671z"></path></svg></button> <button class="p-2 border-l flex justify-center items-center" style="display:none;"><span class="pl-1 text-xs">打开目录</span></button> <button class="p-2 border-l flex justify-center items-center" style="display:none;"><span class="pl-1 text-xs">返回顶部</span></button></div></div> <footer class="bg-gray-300 w-full p-10 flex flex-col md:flex-row justify-between items-center" data-v-496c892e><button class="relative" data-v-496c892e><a href="/" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/Ben.png" alt="avatar" class="w-auto h-12 rounded-full" data-v-496c892e></button> <div class="copyright py-5 md:py-0" data-v-496c892e><p class="text-center text-sm" data-v-496c892e>
      ©2021
      <span class="author" data-v-496c892e>BenThomson</span>. All Right Reserved.
    </p> <p class="text-xs text-center text-gray-400" data-v-496c892e>
      除特殊说明外，本站的文章遵循
      <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" class="text-blue-400" data-v-496c892e>CC-BY-SA-4.0</a>
      协议
    </p></div> <div class="btn-container" data-v-496c892e><button class="relative mx-1" data-v-496c892e><a href="mailto:mebeansbin@gmail.com" target="" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/email.svg" alt="email" class="w-auto h-5" data-v-496c892e></button><button class="relative mx-1" data-v-496c892e><a href="https://github.com/Benbinbin" target="_blank" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/github.svg" alt="github" class="w-auto h-5" data-v-496c892e></button><button class="relative mx-1" data-v-496c892e><a href="https://juejin.cn/user/3175045314389278/posts" target="_blank" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/juejin.svg" alt="juejin" class="w-auto h-5" data-v-496c892e></button><button class="relative mx-1" data-v-496c892e><a href="https://dribbble.com/BinBinDesign" target="_blank" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/dribbble.svg" alt="dribbble" class="w-auto h-5" data-v-496c892e></button><button class="relative mx-1" data-v-496c892e><a href="https://twitter.com/Benbinbin_fun" target="_blank" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/twitter.svg" alt="twitter" class="w-auto h-5" data-v-496c892e></button><button class="relative mx-1" data-v-496c892e><a href="https://weibo.com/binbindesign" target="_blank" class="absolute top-0 right-0 w-full h-full" data-v-496c892e></a> <img src="/tech-blog/img/weibo.svg" alt="weibo" class="w-auto h-5" data-v-496c892e></button></div></footer> <!----> <div class="tooltip fixed inset-x-4 top-20 z-10 border bg-gray-50 bg-opacity-95 rounded-xl border-gray-300 shadow" style="display:none;"><div class="headings-tooltip-container" data-v-e14be5f8><ul class="m-2 pt-8 relative flex justify-between overflow-x-auto" data-v-e14be5f8></ul></div></div></div><div class="global-ui"></div></div>
    <script src="/tech-blog/assets/js/app.e2907910.js" defer></script><script src="/tech-blog/assets/js/19.4fae91a9.js" defer></script><script src="/tech-blog/assets/js/1.c19b0b73.js" defer></script><script src="/tech-blog/assets/js/73.c5de23cd.js" defer></script>
  </body>
</html>
